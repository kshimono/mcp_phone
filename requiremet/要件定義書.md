# QRV (Qualfia Reservation) 要件定義書

**文書バージョン:** 1.9
**作成日:** 2025-01-26
**最終更新日:** 2025-01-27
**プロジェクトコード:** QRV
**プロジェクト名（英語）:** Qualfia Reservation
**プロジェクト名（日本語）:** 未定
**関連文書:** [要件定義_図表.md](要件定義_図表.md)

---

## 目次

1. [概要](#1-概要)
2. [プロジェクトの目的と背景](#2-プロジェクトの目的と背景)
3. [システム概要](#3-システム概要)
4. [機能要件【共通仕様】](#4-機能要件共通仕様)
5. [サービスタイプ拡張仕様【可変部分】](#5-サービスタイプ拡張仕様可変部分)
6. [非機能要件](#6-非機能要件)
7. [データモデル](#7-データモデル)
8. [外部連携](#8-外部連携)
9. [制約事項](#9-制約事項)
10. [今後の拡張予定](#10-今後の拡張予定)
11. [用語集](#11-用語集)

**参考:** タイミング図、サービスタイプ比較表、概念データモデルは[要件定義_図表.md](要件定義_図表.md)を参照してください。

---

## 1. 概要

### 1.1 プロジェクト概要

QRV（Qualfia Reservation）は、AIエージェントを活用した電話予約代行・決済代行システムです。様々な業種に対応可能な汎用的な設計とし、サンプル実装として時間制サービス（出張マッサージ）とサイズオーダー型サービス（花の配送）を例示します。将来的にはケータリング、会場予約など多様なサービスへ展開可能です。

### 1.2 主要機能

- **AIチャット予約受付**: Claude Desktop、ChatGPT等のMCPクライアントから予約依頼を受付
- **予約状況問い合わせ**: MCP経由で予約IDによる状況確認が可能
- **自動音声電話代行**: 提携店に自動音声で電話し、予約を確定
- **決済代行**: Stripeを利用したオンライン決済
- **キャンセル処理**: 予約日時の48時間前までURL経由でキャンセル可能
- **SMS/Email通知**: 依頼者・提携店への自動通知
- **並列処理**: 複数予約の同時処理に対応

### 1.3 提供主体

- **運営会社**: 株式会社Qualfia
- **サービス提供者**: 提携事業者（サンプル: マッサージ店、花屋等。依頼者には店舗名を非公開）

### 1.4 対象ユーザー

- **依頼者**: 個人（サービスを利用する一般消費者）
- **提携店**: サービス提供事業者（サンプル: マッサージ店、花屋等）

---

## 2. プロジェクトの目的と背景

### 2.1 目的

1. **電話予約の自動化**: 人手を介さず、AIが自動で電話予約を完結
2. **顧客体験の向上**: チャットベースの簡単な予約フロー
3. **提携店の負荷軽減**: 標準化された予約情報の伝達
4. **スケーラビリティ**: 複数サービスへの展開可能な設計

### 2.2 背景

- 多様な業種における電話予約の煩雑さ（依頼者・提携店双方の負担）
- AI音声技術の成熟（Bland.ai、OpenAI Realtime API等）
- MCP（Model Context Protocol）による汎用的なインターフェース
- 事前に料金を定義できるサービス領域における自動化ニーズ

---

## 3. システム概要

### 3.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│  依頼者                                                      │
│  └─ Claude Desktop / ChatGPT (MCP Client)                   │
└────────────────┬────────────────────────────────────────────┘
                 │ MCP Protocol
                 ▼
┌─────────────────────────────────────────────────────────────┐
│  QRV System                                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ MCP Server (Python)                                  │   │
│  │  - create_reservation                                │   │
│  │  - check_reservation_status                          │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ API Server (FastAPI)                                 │   │
│  │  - 予約管理                                           │   │
│  │  - 決済管理                                           │   │
│  │  - 通知管理                                           │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Task Queue (Celery + Redis)                          │   │
│  │  - 並列予約処理                                        │   │
│  │  - 電話発信タスク                                      │   │
│  │  - 通知送信タスク                                      │   │
│  └──────────────────────────────────────────────────────┘   │
└────┬────────────┬────────────┬────────────┬────────────────┘
     │            │            │            │
     ▼            ▼            ▼            ▼
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐
│ Bland.ai│ │ Twilio  │ │ Stripe  │ │ SQLite/     │
│ (電話)  │ │ (SMS)   │ │ (決済)  │ │ PostgreSQL  │
└─────────┘ └─────────┘ └─────────┘ └─────────────┘
     │            │
     ▼            ▼
┌─────────────────────┐  ┌──────────────┐
│ 提携店              │  │ SendGrid     │
│ (CSV管理)           │  │ (Email)      │
└─────────────────────┘  └──────────────┘
```

### 3.2 処理フロー概要

1. **予約依頼**: 依頼者がMCPクライアントでAIとチャット
2. **SMS確認**: 依頼者の電話番号にSMS送信、10分以内に確認
3. **電話代行**: 提携店に直列で自動音声電話（最大2周、2周目は応答なし・話中の店のみ）
4. **決済**: 予約成功後、依頼者にSMSで決済リンク送信（10分以内）
5. **決済リマインダー**: 5分経過時点で未決済の場合、リマインダーSMS送信
6. **確定**: 決済完了で予約確定、依頼者・提携店に通知
7. **リマインダー**: 予約日の48時間前と2時間前にSMS送信
8. **キャンセル**: 予約日時の48時間前まで、キャンセルURL経由で可能

---

## 4. 機能要件【共通仕様】

本章では、サービスタイプに依存しない共通機能を定義します。
サービス固有の仕様については、第5章「サービスタイプ拡張仕様」を参照してください。


### 4.1 予約受付機能

#### 4.1.1 チャット予約受付

**機能概要:**
- MCPクライアント（Claude Desktop、ChatGPT等）から予約依頼を受付
- AIエージェントがサービスタイプに応じた必要情報を対話的に収集

**入力情報:**
- サービスタイプコード（例: 00001, 00002）
- サービス固有の詳細情報（サービスタイプごとに異なる）
- 連絡先電話番号（全サービス共通）

**処理:**
1. サービスタイプに応じた要件定義を読み込み
2. 必須項目が揃っているかチェック
3. 不足情報をAIが対話で確認
4. 全情報が揃ったら予約内容を依頼者に確認
5. 依頼者が承認したら予約リクエスト作成

**出力:**
- 予約ID（例: QRV-A3F9D2）
- 「SMSで確認リンクを送信します」メッセージ

**エラーケース:**
- サービスタイプが不明: サービス一覧を提示
- 必須情報不足: 不足項目を再度質問
- 電話番号形式エラー: 正しい形式での再入力を依頼

**AIエージェントの対話方針:**

AIエージェントは、**固定的な対話テンプレートに依存せず**、以下の方針で柔軟に対話を進めます。

**基本方針:**
1. **必須項目の完全収集**: サービスタイプごとの必須項目を全て収集するまで対話を継続
2. **柔軟な質問順序**: 依頼者が提供した情報に応じて、質問の順序を動的に調整
3. **曖昧さの解消**: 不明確な情報は具体的に確認し、誤解を防ぐ
4. **修正要求への対応**: 依頼者からの修正要求に柔軟に対応
5. **最終確認の実施**: 全情報収集後、予約内容を整理して最終確認を取る

**対話の進め方:**
- 依頼者が部分的な情報を提供した場合: 不足項目のみを追加で質問
- 依頼者が全情報を提供した場合: 即座に最終確認へ進む
- 依頼者が曖昧な表現を使用した場合: 具体的な確認で明確化
- 依頼者が修正を要求した場合: 該当項目のみ再確認

**重要:** 会話テンプレートは定義せず、AIエージェントが状況に応じて自然な対話を行います。具体的な対話例は、第5章「サンプル実装」を参照してください。

---

#### 4.1.2 予約状況問い合わせ

**機能概要:**
- MCP経由で予約IDを指定して状況を確認
- セッションが切断された場合でも予約状況を確認可能

**入力情報:**
- 予約ID（例: QRV-A3F9D2）

**処理:**
1. 予約IDでDB検索
2. 現在のステータスを返却
3. 決済待ちの場合は決済リンクを再送信可能に

**出力:**
- 予約ステータス
- 予約内容の詳細
- 次に取るべきアクション（決済待ち、電話代行中等）

**対話パターン:**
```
[依頼者] 予約ID QRV-XXXXXXの状況を教えて

[AI] 予約ID: QRV-XXXXXXの状況を確認しました。

     【現在の状況】
     ステータス: [ステータス名]
     サービス: {サービス名}
     日時: {予約日時}
     住所: {住所}
     料金: {料金}円

     [次のアクション案内]

     [必要に応じて] 決済リンクを再送しますか？
```

**エラーケース:**
- 予約IDが存在しない: 「予約が見つかりません」
- 予約が既にキャンセル済み: 「この予約はキャンセルされています」

---

#### 4.1.3 SMS確認機能

**機能概要:**
- 依頼者の電話番号にSMS送信
- 10分以内に「進める」ボタンを押すと電話代行開始
- タイムアウト時間は設定パラメータとして管理可能

**処理:**
1. 予約リクエスト作成後、即座にSMS送信（最大3回リトライ）
2. SMS内容: 予約内容 + 「進める」「キャンセル」ボタン付きリンク
3. 依頼者が「進める」押下 → 電話代行タスク開始
4. 依頼者が「キャンセル」押下 → 予約リクエスト削除、通知なし
5. 10分経過で未押下 → 予約リクエスト削除、最初からやり直し

**SMS送信失敗時:**
- 最大3回リトライ
- 全て失敗 → AIチャットで「SMSが送信されるまで本セッションは切らないでください」と表示
- 電話番号確認を促す

---


### 4.2 電話代行機能

#### 4.2.1 提携店選定

**機能概要:**
- サービスタイプに応じた提携店CSVを読み込み
- 対応エリアでフィルタリング
- 電話受付時間内の店舗のみを抽出
- スコア降順でソート

**処理:**
1. `data/shops_{service_type}.csv` を読み込み
2. `supported_areas` に依頼者の住所（区）が含まれる店舗を抽出
3. 現在時刻が `phone_reception_start` 〜 `phone_reception_end` の範囲内の店舗のみを抽出
4. `score`（降順）でソート
5. ソート済みリストを返す

**電話受付時間外の場合:**
- 受付時間内の店舗がない場合は、全店NGとして扱う
- 依頼者にSMSで「現在、受付時間外のため予約できませんでした」と通知
- 予約ステータスを `failed` に更新して処理終了

---

#### 4.2.2 自動音声電話

**機能概要:**
- 提携店に直列で自動音声電話
- 仮予約成功したら終了、全店NGなら2周まで試行

**電話スクリプト構成:**

**1. Opening（全サービス共通）**
```
[AI] こんにちは、Qualfia 電話予約代行です。今お電話可能でしょうか？
[店] はい
[AI] ご担当者はいらっしゃいますか？
[店] ＜担当者に取り次ぎ＞
[AI] ありがとうございます。サービスタイプ番号 {service_type} {service_name}です。
```

**2. Requirements（伝えるべき内容、サービス固有）**
- サービス要件定義から `requirements_to_communicate` を読み込み
- テンプレートに変数を埋め込んで伝達
- サービスタイプごとに異なる内容を伝達（詳細は第5章参照）

**3. Confirmation（確認メッセージ、サービス固有）**
- サービス要件定義から `confirmation_messages` を読み込み
- テンプレートに変数を埋め込んで確認
- 仮予約の説明を含める：
  ```
  【重要】お客様が10分以内に決済されない場合は、自動的にキャンセルとなります。
  決済完了まで、この時間枠は仮押さえとして扱っていただき、
  他のご予約も並行して受け付けていただいて構いません。
  決済完了後、改めて確定通知をお送りいたします。
  ```

**店側の応答パターン:**

| 応答 | 処理 |
|------|------|
| 予約成功 | 通話ログ記録、次の処理へ |
| 時間帯が埋まっている | 代替案があれば記録、次の店へ |
| エリア対応不可 | 通話ログ記録、次の店へ |
| 電話に出ない（30秒） | 通話ログ記録、次の店へ |
| 追加情報要求（性別等） | 「詳細はお客様と直接」と回答、対応不可なら次の店へ |
| 時間外提案（希望外） | 代替案として記録、次の店へ |

**リトライロジック:**
- 1周目: 全提携店に順次電話
- 全店NG → 2周目開始（応答なし・話中の店舗のみ）
- 2周目: 1周目で「応答なし」「話中」だった店舗のみ再トライ
- 2周目も全店NG → 全店NG処理へ

**2周目の対象:**

| 1周目の結果 | 2周目で再トライ |
|------------|----------------|
| 応答なし（30秒タイムアウト） | ✓ する |
| 話中 | ✓ する |
| 時間帯が埋まっている | ✗ しない |
| エリア対応不可 | ✗ しない |
| 追加情報要求で対応不可 | ✗ しない |
| その他の理由で不可 | ✗ しない |

**通話ログ記録:**
- 予約ID、店舗ID、試行回数（1周目/2周目）
- 通話結果（成功/不可/応答なし/エリア外等）
- 代替案（時間外提案等）
- 通話時間

---

#### 4.2.3 全店NG時の処理

**機能概要:**
- 2周しても全店NGの場合、依頼者に代替案を提示

**処理:**
1. 通話ログから代替案を抽出
2. 代替可能な時間帯をまとめる
3. 依頼者にSMS送信

**SMS内容:**
```
【Qualfia予約代行】

申し訳ございません。
ご希望の条件で予約できませんでした。

■ ご依頼内容
日時: {希望日時}（例: 1月28日 14:00-17:00の間）
サービス: {サービス名} {詳細}（例: アロママッサージ 60分）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）

■ 代替可能な時間帯
以下の時間帯でしたら予約可能な見込みです：
- {代替案}（例: 1月28日 18:00以降）

■ 再予約する場合
以下のテキストをコピーしてAIエージェントに貼り付けてください：

---
{再予約用プロンプト}
---
```

---

### 4.3 決済機能

#### 4.3.1 決済リンク送信

**機能概要:**
- 仮予約成功後、依頼者にSMSで決済リンク送信
- 10分以内に決済完了で予約確定

**処理:**
1. 料金計算（サービスタイプに応じた計算ロジック、詳細は第5章参照）
2. Stripe Checkout Session作成
3. 依頼者にSMS送信（最大3回リトライ）
4. 提携店にもSMS/Email送信

**依頼者へのSMS:**
```
【Qualfia予約代行】予約が完了しました。

■ 予約内容
予約ID: {予約ID}（例: QRV-A3F9D2）
サービス: {サービス名}（例: アロママッサージ）
日時: {予約日時}（例: 1月28日(火) 15:00-16:00）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）
料金: {料金}円（例: 2,200円）

【重要】10分以内に決済しないと自動キャンセルされます

以下のリンクから決済してください：
https://qualfia.com/phone/book/{予約ID}
```

**提携店へのSMS:**
```
【Qualfia予約代行】予約が確定しました。

予約ID: {予約ID}（例: QRV-A3F9D2）
日時: {予約日時}（例: 1月28日(火) 15:00-16:00）
サービス: {サービス詳細}（例: アロママッサージ 60分）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）
お客様電話: {電話番号}
料金: {料金}円（決済待ち）

10分以内にお客様が決済されない場合は、キャンセルとなります。
決済完了後、再度ご連絡いたします。
```

**SMS送信失敗時:**
- 最大3回リトライ
- 全て失敗 → 予約を自動キャンセル、提携店にも通知

---

#### 4.3.2 決済処理

**機能概要:**
- Stripe Checkoutで決済処理
- 10分のタイムアウト監視

**処理:**
1. 依頼者が決済リンクをクリック
2. Stripe Checkoutページ表示
3. 決済完了 → Webhookで通知受信
4. 予約ステータスを「paid」に更新
5. 依頼者・提携店に確定SMS送信

**依頼者への決済完了SMS:**
```
【Qualfia予約代行】決済が完了しました。予約が確定しました。

■ 予約内容
予約ID: {予約ID}（例: QRV-A3F9D2）
サービス: {サービス名}（例: アロママッサージ）
日時: {予約日時}（例: 1月28日(火) 15:00-16:00）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）
料金: {料金}円（決済済み）

当日は担当者が直接お伺いします。
2日前と2時間前にリマインダーSMSをお送りします。

キャンセルは48時間前まで可能です：
https://qualfia.com/phone/cancel/{予約ID}
```

**提携店への決済完了SMS:**
```
【Qualfia予約代行】お客様の決済が完了しました。予約が確定しました。

予約ID: {予約ID}（例: QRV-A3F9D2）
日時: {予約日時}（例: 1月28日(火) 15:00-16:00）
サービス: {サービス詳細}（例: アロママッサージ 60分）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）
お客様電話: {電話番号}
料金: {料金}円（決済済み）

2日前と2時間前にリマインダーSMSをお送りします。
```

**10分タイムアウト時:**
1. 決済未完了を検知
2. 予約を自動解放
3. 依頼者・提携店にリリース通知SMS送信

**依頼者へのリリース通知:**
```
【Qualfia予約代行】

予約ID: {予約ID}

10分以内に決済が完了しなかったため、予約を解放しました。
再度予約をご希望の場合は、AIエージェント経由でお願いします。
```

**提携店へのリリース通知:**
```
【Qualfia予約代行】

予約ID: {予約ID}

お客様の決済が完了しなかったため、予約をキャンセルいたしました。
```

---

### 4.4 通知機能

#### 4.4.1 リマインダー送信

**機能概要:**
- 予約日の48時間前と2時間前にSMS送信（2回）
- リマインダー送信時間は設定パラメータとして管理可能

**第1回リマインダー（48時間前）:**

**依頼者へのリマインダー:**
```
【Qualfia予約代行】予約のリマインダーです。

予約ID: {予約ID}（例: QRV-A3F9D2）
日時: {予約日時}（2日後）（例: 1月28日(火) 15:00-16:00）
サービス: {サービス詳細}（例: アロママッサージ 60分）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）

キャンセルは48時間前まで可能です：
https://qualfia.com/phone/cancel/{予約ID}
```

**提携店へのリマインダー:**
```
【Qualfia予約代行】予約のリマインダーです。

予約ID: {予約ID}（例: QRV-A3F9D2）
日時: {予約日時}（2日後）（例: 1月28日(火) 15:00-16:00）
サービス: {サービス詳細}（例: アロママッサージ 60分）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）
お客様電話: {電話番号}
```

**第2回リマインダー（2時間前）:**

**依頼者へのリマインダー:**
```
【Qualfia予約代行】まもなく予約時間です。

予約ID: {予約ID}（例: QRV-A3F9D2）
日時: 本日 {時刻}（2時間後）（例: 15:00-16:00）
サービス: {サービス詳細}（例: アロママッサージ 60分）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）

担当者が直接お伺いします。
```

**提携店へのリマインダー:**
```
【Qualfia予約代行】まもなく予約時間です。

予約ID: {予約ID}（例: QRV-A3F9D2）
日時: 本日 {時刻}（2時間後）（例: 15:00-16:00）
サービス: {サービス詳細}（例: アロママッサージ 60分）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）
お客様電話: {電話番号}
```

**実装:**
- Celery Beatで定期実行（例: 毎時0分）
- 予約日時の48時間前・2時間前に該当する予約を抽出
- SMS送信（リトライ3回、失敗時はログ記録のみ）

---

#### 4.4.2 Email通知

**機能概要:**
- 提携店にEmail通知（SMSの補助）

**送信タイミング:**
- 仮予約成功時
- 決済完了時
- 予約解放時
- キャンセル時

**内容:**
- SMSと同等の情報をHTML形式で送信

---

#### 4.4.3 決済リマインダー

**機能概要:**
- 決済リンク送信から5分経過後、未決済の場合にSMS送信
- リマインダー送信時間は設定パラメータとして管理可能

**依頼者への決済リマインダー:**
```
【Qualfia予約代行】決済のリマインダーです。

予約ID: {予約ID}（例: QRV-A3F9D2）

残り時間: 5分

【重要】10分以内に決済しないと自動キャンセルされます

以下のリンクから決済してください：
https://qualfia.com/phone/book/{予約ID}
```

**実装:**
- 決済リンク送信時にCeleryタスクをスケジュール（5分後実行）
- 5分後にステータス確認、未決済ならSMS送信
- SMS送信（リトライ3回、失敗時はログ記録のみ）

---

### 4.5 管理機能

#### 4.5.1 管理画面（初期MVP）

**機能概要:**
- コマンドライン/ログファイルで確認

**確認項目:**
- 予約一覧（予約ID、依頼者電話番号、提携店、ステータス）
- 決済状況
- 提携店リスト
- システムログ

**将来実装予定:**
- Web管理画面（Streamlit等）

---

### 4.6 キャンセル機能

#### 4.6.1 キャンセルポリシー

**原則:**
- 予約日時の48時間前まで: キャンセル可能（全額返金）
- 48時間前以降: キャンセル不可（返金なし）
- キャンセル期限は設定パラメータとして管理可能

**キャンセル方法:**
- 決済完了SMS内のキャンセルURLから実行
- キャンセルURL有効期限: 予約日時の48時間前まで

**キャンセルURL:**
- 形式: `https://qualfia.com/phone/cancel/{reservation_id}`
- 決済完了SMS、第1回リマインダー（48時間前）に含める

#### 4.6.2 キャンセル処理フロー

**処理:**
1. 依頼者がキャンセルURLをクリック
2. キャンセル確認画面を表示
3. 依頼者が「キャンセルする」ボタン押下
4. 予約ステータスを「cancelled」に更新
5. Stripeで返金処理を実行
6. 依頼者・提携店に即座にSMS送信

**依頼者へのキャンセル完了SMS:**
```
【Qualfia予約代行】キャンセルが完了しました。

予約ID: {予約ID}（例: QRV-A3F9D2）
サービス: {サービス名}（例: アロママッサージ）
日時: {予約日時}（例: 1月28日(火) 15:00-16:00）
料金: {料金}円（全額返金）

返金処理は3-5営業日で完了します。
```

**提携店へのキャンセル通知SMS:**
```
【Qualfia予約代行】予約がキャンセルされました。

予約ID: {予約ID}（例: QRV-A3F9D2）
日時: {予約日時}（例: 1月28日(火) 15:00-16:00）
サービス: {サービス詳細}（例: アロママッサージ 60分）
住所: {住所}（例: 東京都渋谷区道玄坂1-2-3）

この時間枠は解放されました。
```

**提携店へのキャンセル通知Email:**
- SMS送信と同時にEmail送信
- 内容はSMSと同等

#### 4.6.3 48時間前以降のキャンセル

**エラーメッセージ:**
```
【Qualfia予約代行】

予約ID: {予約ID}

キャンセル期限（48時間前）を過ぎているため、
キャンセルできません。

緊急の場合は以下にメール連絡してください：
inquiry@qualfia.com
```

**例外対応:**
- 緊急時のみ、inquiry@qualfia.com にメール連絡
- 現時点では手動対応

**将来実装予定:**
- 自動キャンセル処理（一定条件下）
- キャンセル料の段階的設定（48時間前: 無料、24時間前: 50%等）

---

## 5. サービスタイプ拡張仕様【可変部分】

### 5.1 サービスタイプの定義方法

#### 5.1.1 サービスタイプの構成要素

新規サービスを追加する際は、以下の要素を定義する必要があります。

**基本情報:**
- **サービスコード**: 5桁の番号（例: 00001）
- **サービス名（英語）**: システム内部での識別名（例: Aroma Massage）
- **表示名（日本語）**: 依頼者に表示する名称（例: アロママッサージ）
- **対応エリア**: サービスが対応可能な地域
- **受付期限**: 最短・最長の予約可能期間

**データ関連:**
- **提携店CSV**: `data/shops_{service_code}.csv`
- **固有項目定義**: サービス固有の確認項目（JSON Schema形式）
- **料金体系パターン**: 時間制 or サイズオーダー型

**対話・通信関連:**
- **確認項目とプロンプト**: AIが依頼者に確認する項目と質問文
- **電話スクリプトテンプレート**: 提携店への電話で伝える内容
- **確認メッセージテンプレート**: 予約内容の最終確認文言

---

#### 5.1.2 ファイル構成

サービスタイプごとに以下のファイルを作成します。

```
project_root/
├── data/
│   ├── shops_00001.csv          # アロママッサージ提携店
│   ├── shops_00002.csv          # 胡蝶蘭配送提携店
│   └── ...
├── config/
│   ├── service_00001.json       # アロママッサージ定義
│   ├── service_00002.json       # 胡蝶蘭配送定義
│   └── ...
```

**service_{code}.json の構造例:**
```json
{
  "service_code": "00001",
  "service_name": "Aroma Massage",
  "display_name": "アロママッサージ",
  "service_area": "東京23区",
  "booking_window": {
    "min_hours_ahead": 24,
    "max_days_ahead": 30
  },
  "pricing_pattern": "time_based",
  "required_fields": [...],
  "optional_fields": [...],
  "phone_script_template": "...",
  "confirmation_template": "..."
}
```

---

### 5.2 サービス固有項目の設計指針

#### 5.2.1 新規サービス追加時のチェックリスト

新規サービスを追加する際は、以下の項目を確認してください。

**必須確認項目:**
- [ ] サービスコードを決定（既存コードと重複しないこと）
- [ ] 料金体系パターンを決定（時間制 or サイズオーダー型）
- [ ] 提携店CSVを作成（最低5店舗以上推奨）
- [ ] サービス定義JSONを作成
- [ ] 依頼者への確認項目を定義（必須/任意を明記）
- [ ] 電話スクリプトテンプレートを作成
- [ ] 料金計算ロジックを実装
- [ ] SMSテンプレートをカスタマイズ（必要に応じて）

**推奨確認項目:**
- [ ] 代替案の扱いを検討（時間変更、商品変更等）
- [ ] バリデーションルールを定義
- [ ] テストケースを作成（正常系・異常系）

---

#### 5.2.2 料金体系パターン

本システムでは、以下の2つの料金体系パターンに対応します。

##### パターン1: 時間制（Time-based）

**概要:**
- サービス提供時間に応じて料金が変動
- 1分単位で料金を計算
- ただし、受注は10分単位で受け付ける

**料金構成:**
- ベース料金（固定）
- 単位時間あたりの料金（変動）
- 時間帯による料金変動（任意、サービスごとに設定可能）
  - 例: 深夜時間帯（22:00-6:00）は料金が高い

**計算式:**
```
総額 = ベース料金 + Σ(各時間帯の単位料金 × その時間帯の利用分数)
```

**計算例（アロママッサージ60分、21:30開始）:**
- ベース料金: 1,000円
- 通常時間帯（6:00-22:00）: 120円/分
- 深夜時間帯（22:00-6:00）: 150円/分
- 計算:
  - 21:30-22:00（30分）: 120円 × 30 = 3,600円
  - 22:00-22:30（30分）: 150円 × 30 = 4,500円
  - 合計: 1,000円 + 3,600円 + 4,500円 = 9,100円

**受注単位と計算単位の違い:**
- **受注**: 10分単位（40分、50分、60分...120分）
- **計算**: 1分単位で正確に計算
- 例: 60分受注 → 1分単位で60分の料金を計算

**適用サービス例:**
- 出張マッサージ（アロマ、タイ等）
- 家事代行
- レンタルスペース

---

##### パターン2: サイズオーダー型（Size-order）

**概要:**
- 商品サイズや種類によって料金が固定
- 数量は常に1（複数注文は別予約として扱う）

**料金構成:**
- サイズごとの固定料金
- 配送料込み（オプション扱いも可）

**計算式:**
```
総額 = 選択したサイズの固定料金
```

**料金例（胡蝶蘭配送）:**
- 3本立て: 15,000円（配送料込み）
- 6本立て: 25,000円（配送料込み）
- 10本立て: 30,000円（配送料込み）

**適用サービス例:**
- 花の配送（胡蝶蘭、アレンジメント等）
- ケータリング（弁当配達等）
- 商品配送

---

#### 5.2.3 電話スクリプトの設計

**基本構造:**
1. **Opening（全サービス共通）**: 既に4.2.2で定義済み
2. **Requirements（サービス固有）**: 必要情報を伝達
3. **Confirmation（サービス固有）**: 予約内容を確認

**設計ポイント:**
- 必要最小限の情報のみ伝達
- 依頼者の個人情報（氏名、年齢、性別等）は伝えない
- 予約に必要な情報: 日時、場所、サービス内容のみ
- 追加情報が必要な場合は、提携店が依頼者と直接確認

**テンプレート変数の例:**
- `{date}`: 予約日
- `{time_range}`: 時間帯
- `{preferred_duration}`: 希望時間
- `{fallback_duration}`: 代替時間
- `{address}`: 住所
- `{orchid_size}`: 胡蝶蘭のサイズ
- `{stand_message}`: 立て札メッセージ

**外部設計時の重要な注意点:**

音声AI（Bland.ai等）を使用した提携店との電話対応において、以下の点に注意が必要です。

1. **柔軟な会話フロー**: サンプルスクリプト通りに提携店が回答しない場合でも、音声AIが柔軟に会話を継続できるよう設計すること
2. **想定外の応答への対応**: 提携店が質問で返答した場合、予想外の情報を追加した場合でも、必要情報を確実に収集できること
3. **中断・再開の処理**: 提携店が「少々お待ちください」と言って保留にした場合の処理
4. **理解確認の実施**: 重要な情報（日時、場所等）は提携店に復唱確認を求めること

**注:** 第5章のサンプルスクリプトは理想的な会話例であり、実際の外部設計では上記の柔軟性を確保する必要があります。

---

#### 5.2.4 バリデーションルールの定義

**共通バリデーション:**
- 電話番号: 携帯電話番号（080/090/070で始まる11桁）

**サービス固有バリデーション例:**
- 時間制サービス:
  - 受注単位: 10分刻み
  - 最小時間: サービスごとに定義（例: 40分）
  - 最大時間: サービスごとに定義（例: 120分）
- サイズオーダー型:
  - サイズ選択: 定義されたサイズのみ
  - 数量: 1固定（複数注文は別予約）

**エラーメッセージ:**
- バリデーションエラー時は、依頼者に具体的な修正方法を提示

---

### 5.3 サンプル実装

**注:** 以下は本システムの動作を示すサンプル実装です。実際のサービス内容は運用時に決定します。

**重要:** 以下の対話サンプルや電話スクリプトは、理想的な会話フローの例示です。実際の運用では、依頼者や提携店がサンプル通りに応答しない場合でも、AIエージェント・音声AIが柔軟に対話を進め、必要な情報を確実に収集できるよう設計する必要があります。

---

#### 5.3.1 サンプル1: 時間制サービス（出張型アロママッサージ）

##### 基本情報

- **サービスコード:** 00001
- **サービス名:** Aroma Massage
- **表示名:** アロママッサージ
- **対応エリア:** 東京23区
- **受付期限:** 最短24時間前、最長30日先
- **料金体系パターン:** 時間制

##### 確認項目

**共通項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| customer_phone | 必須 | 連絡先の電話番号を教えてください |

**サービス固有項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| delivery_address | 必須 | 派遣先の住所を教えてください（例: 東京都渋谷区道玄坂1-2-3） |
| preferred_date | 必須 | 希望の日付を教えてください（例: 明日、1月28日） |
| time_range | 必須 | 希望の時間帯を教えてください（例: 14時から17時の間） |
| preferred_duration | 必須 | 希望の時間を教えてください（40分〜120分、10分刻み） |
| fallback_duration | 任意 | 難しい場合の代替時間はありますか？ |

##### 料金体系

- **ベース料金:** 1,000円
- **通常時間帯（6:00-22:00）:** 120円/分
- **深夜時間帯（22:00-6:00）:** 150円/分

**計算例: 21:30開始60分の場合**
- 21:30-22:00（30分）: 120円 × 30 = 3,600円
- 22:00-22:30（30分）: 150円 × 30 = 4,500円
- 合計: 1,000円 + 3,600円 + 4,500円 = 9,100円

##### 電話スクリプト（Requirements部分）

```
[AI] {date}の{time_range}で、{preferred_duration}分のアロママッサージをお願いしたいのですが、
     難しい場合は{fallback_duration}分でも構いません。
     場所は{address}です。ご対応可能でしょうか？
```

##### 電話スクリプト（Confirmation部分）

```
[AI] それでは、{confirmed_date} {confirmed_time}から{confirmed_duration}分で間違いないでしょうか？
[店] はい
[AI] 場所は{address}で承知しました。
     予約番号は{reservation_id}です。
     後ほどSMSとメールで詳細をお送りいたします。

     【重要】お客様が10分以内に決済されない場合は、自動的にキャンセルとなります。
     決済完了まで、この時間枠は仮押さえとして扱っていただき、
     他のご予約も並行して受け付けていただいて構いません。
     決済完了後、改めて確定通知をお送りいたします。
```

##### 対話サンプル（具体例）

以下、依頼者とAIエージェントの対話例を示します。これは4章の汎用パターンを具体化したものです。

**サンプル1-1: スムーズな予約**

```
[依頼者] 明日の午後、渋谷でアロママッサージを予約したい

[AI] かしこまりました。アロママッサージのご予約ですね。
     以下の情報を教えてください。

     1. 派遣先の住所（渋谷区内の詳細な住所）
     2. 希望の時間帯（例: 14時から17時の間）
     3. 希望の時間（40分〜120分、10分刻み）
     4. 連絡先の電話番号

[依頼者] 渋谷区道玄坂1-2-3、14時から17時の間で1時間、080-1234-5678

[AI] ありがとうございます。確認させてください。

     【予約内容】
     - サービス: アロママッサージ
     - 住所: 東京都渋谷区道玄坂1-2-3
     - 日時: 2025年1月28日 14:00-17:00の間
     - 希望時間: 60分
     - 電話番号: 080-1234-5678

     この内容で予約を進めてよろしいですか?

[依頼者] はい

[AI] 承知しました。予約処理を開始します。

     【予約ID: QRV-A3F9D2】

     まもなく 080-1234-5678 宛にSMSで確認リンクをお送りします。
     10分以内に「進める」ボタンを押してください。

     SMSが送信されるまで本セッションは切らないでください。

[AI] SMSを送信しました。10分以内にご確認ください。
     その後、提携店に電話で予約を取り、結果をSMSでお知らせします。
```

**サンプル1-2: 全情報を最初から提供**

```
[依頼者] 明日14-17時の間で60分、渋谷区道玄坂1-2-3でアロママッサージ予約、080-1234-5678

[AI] ありがとうございます。全ての情報を確認させてください。

     【予約内容】
     - サービス: アロママッサージ
     - 住所: 東京都渋谷区道玄坂1-2-3
     - 日時: 2025年1月28日 14:00-17:00の間
     - 希望時間: 60分
     - 電話番号: 080-1234-5678

     この内容で予約を進めてよろしいですか？

[依頼者] はい

[AI] 承知しました。予約処理を開始します。

     【予約ID: QRV-D5H1K9】

     まもなく 080-1234-5678 宛にSMSで確認リンクをお送りします。
```

**サンプル1-3: 複雑な条件（fallback含む）**

```
[依頼者] 明日15-18時で1時間のアロママッサージ、難しかったら40分でもいい、
         渋谷区道玄坂1-2-3、080-1234-5678

[AI] ありがとうございます。詳細な条件を承知しました。

     【予約内容】
     - サービス: アロママッサージ
     - 住所: 東京都渋谷区道玄坂1-2-3
     - 日時: 2025年1月28日 15:00-18:00の間
     - 希望時間: 60分（難しい場合は40分）
     - 電話番号: 080-1234-5678

     この内容で予約を進めてよろしいですか？

[依頼者] はい

[AI] 承知しました。予約処理を開始します。

     【予約ID: QRV-F3N7Q2】

     まもなく 080-1234-5678 宛にSMSで確認リンクをお送りします。

     ※ 提携店に電話で確認し、60分が難しい場合は40分で調整いたします。
```

---

#### 5.3.2 サンプル2: サイズオーダー型サービス（胡蝶蘭配送）

##### 基本情報

- **サービスコード:** 00002
- **サービス名:** Orchid Delivery
- **表示名:** 胡蝶蘭配送
- **対応エリア:** 東京23区
- **受付期限:** 最短24時間前、最長30日先
- **料金体系パターン:** サイズオーダー型

##### 確認項目

**共通項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| customer_phone | 必須 | 連絡先の電話番号を教えてください |

**サービス固有項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| delivery_address | 必須 | 配送先の住所を教えてください |
| delivery_date | 必須 | 配送希望日を教えてください（例: 明日、1月28日） |
| orchid_size | 必須 | 胡蝶蘭のサイズを選んでください：<br>1. 3本立て（15,000円）<br>2. 6本立て（25,000円）<br>3. 10本立て（30,000円） |
| stand_message | 必須 | 立て札の内容を教えてください（例: 祝 開店、お祝い） |

##### 料金体系

- **3本立て:** 15,000円（配送料込み）
- **6本立て:** 25,000円（配送料込み）
- **10本立て:** 30,000円（配送料込み）

**注:** 胡蝶蘭配送は商品サイズによる固定料金制。数量は常に1。複数注文は別予約として扱います。

##### 電話スクリプト（Requirements部分）

```
[AI] {delivery_date}に{address}へ、{orchid_size}の胡蝶蘭の配送をお願いしたいのですが、
     立て札は「{stand_message}」でお願いします。ご対応可能でしょうか？
```

##### 電話スクリプト（Confirmation部分）

```
[AI] それでは、{confirmed_date}に{address}へ、{orchid_size}の胡蝶蘭で間違いないでしょうか？
[店] はい
[AI] 立て札は「{stand_message}」で承知しました。
     予約番号は{reservation_id}です。
     後ほどSMSとメールで詳細をお送りいたします。

     【重要】お客様が10分以内に決済されない場合は、自動的にキャンセルとなります。
     決済完了まで、この枠は仮押さえとして扱っていただき、
     他のご注文も並行して受け付けていただいて構いません。
     決済完了後、改めて確定通知をお送りいたします。
```

##### 対話サンプル（具体例）

**サンプル2-1: スムーズな予約**

```
[依頼者] 胡蝶蘭を配送してほしい

[AI] かしこまりました。胡蝶蘭配送ですね。
     以下の情報を教えてください。

     1. 配送先の住所
     2. 配送希望日
     3. 胡蝶蘭のサイズ（3本立て・6本立て・10本立て）
     4. 立て札の内容
     5. 連絡先の電話番号

[依頼者] 港区六本木1-1-1、明後日、3本立て、「祝 開店」、080-1111-2222

[AI] ありがとうございます。確認させてください。

     【予約内容】
     - サービス: 胡蝶蘭配送
     - 住所: 東京都港区六本木1-1-1
     - 配送日: 2025年1月29日
     - 商品: 3本立て（15,000円）
     - 立て札: 「祝 開店」
     - 電話番号: 080-1111-2222

     この内容で予約を進めてよろしいですか？

[依頼者] はい

[AI] ありがとうございます。予約処理を開始します。

     【予約ID: QRV-C2T9P5】

     まもなく 080-1111-2222 宛にSMSで確認リンクをお送りします。
```

**サンプル2-2: 情報の修正**

```
[依頼者] 胡蝶蘭を配送してほしい

[AI] かしこまりました。胡蝶蘭配送ですね。
     以下の情報を教えてください。

     1. 配送先の住所
     2. 配送希望日
     3. 胡蝶蘭のサイズ（3本立て・6本立て・10本立て）
     4. 立て札の内容
     5. 連絡先の電話番号

[依頼者] 港区六本木1-1-1、明後日、3本立て、「祝 開店」、080-1111-2222

[AI] ありがとうございます。確認させてください。

     【予約内容】
     - サービス: 胡蝶蘭配送
     - 住所: 東京都港区六本木1-1-1
     - 配送日: 2025年1月29日
     - 商品: 3本立て（15,000円）
     - 立て札: 「祝 開店」
     - 電話番号: 080-1111-2222

     この内容で予約を進めてよろしいですか？

[依頼者] やっぱり6本立てに変更で

[AI] 承知しました。6本立て（25,000円）に変更いたします。

     【予約内容】
     - サービス: 胡蝶蘭配送
     - 住所: 東京都港区六本木1-1-1
     - 配送日: 2025年1月29日
     - 商品: 6本立て（25,000円）
     - 立て札: 「祝 開店」
     - 電話番号: 080-1111-2222

     この内容で予約を進めてよろしいですか？

[依頼者] はい

[AI] ありがとうございます。予約処理を開始します。

     【予約ID: QRV-C2T9P5】

     まもなく 080-1111-2222 宛にSMSで確認リンクをお送りします。
```

---

## 6. 非機能要件

### 6.1 性能要件

| 項目 | 要件 |
|------|------|
| 予約処理時間 | 依頼受付から決済リンク送信まで5分以内 |
| 電話応答時間 | 呼び出し30秒で応答なしと判定 |
| SMS送信時間 | 3秒以内（リトライ除く） |
| 同時並列予約 | 初期: 10件/分、将来: 100件/分 |

### 6.2 可用性要件

| 項目 | 要件 |
|------|------|
| システム稼働率 | 99.0%（初期）、99.9%（将来） |
| メンテナンス時間 | 月次、深夜帯（2:00-4:00） |

### 6.3 拡張性要件

| 項目 | 要件 |
|------|------|
| サービスタイプ追加 | コード修正なしで設定ファイルのみで追加可能 |
| 提携店追加 | CSV追加のみで可能 |
| 並列処理スケール | 負荷に応じてCeleryワーカー数を増減可能 |

### 6.4 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 個人情報保護 | 電話番号のみ保持。住所等は予約完了後に削除 |
| 決済情報 | Stripeに委託、自システムでは保持しない |
| API認証 | MCP接続時に認証トークン必須 |
| ログ管理 | システムログは30日間保存（個人情報は含めない） |

### 6.5 運用要件

| 項目 | 要件 |
|------|------|
| エラー通知 | 管理者に即座にSMS通知（080-5496-0516） |
| バックアップ | 毎日深夜にDB自動バックアップ |
| ログ保存 | システムログは30日間保存 |

### 6.6 設定パラメータの管理

本システムでは、以下の項目を設定パラメータとして外部化し、コード修正なしで変更可能とする。

| カテゴリ | パラメータ | デフォルト値 | 説明 |
|---------|-----------|-------------|------|
| **タイムアウト** | SMS確認タイムアウト | 10分（600秒） | SMS確認リンクの有効期限 |
| | 決済タイムアウト | 10分（600秒） | 決済リンクの有効期限 |
| | 決済リマインダー送信時間 | 5分（300秒） | 決済リンク送信から何分後にリマインダー送信 |
| | 電話応答なし判定時間 | 30秒 | 電話の応答なし判定時間 |
| **リマインダー** | 第1回リマインダー | 48時間前 | 予約日時の何時間前に第1回リマインダー送信 |
| | 第2回リマインダー | 2時間前 | 予約日時の何時間前に第2回リマインダー送信 |
| **キャンセル** | キャンセル可能期限 | 48時間前 | 予約日時の何時間前までキャンセル可能 |
| **リトライ** | SMS送信最大リトライ回数 | 3回 | SMS送信失敗時の最大リトライ回数 |
| | 電話代行最大周回数 | 2周 | 電話代行の最大周回数（1周目+2周目） |
| **通知先** | 管理者電話番号 | 080-5496-0516 | エラー通知先の管理者電話番号 |
| | 問い合わせメール | inquiry@qualfia.com | 問い合わせ先メールアドレス |
| **システムURL** | ベースURL | https://qualfia.com/phone | システムのベースURL |
| | 決済URLパス | /book | 決済ページのパス |
| | キャンセルURLパス | /cancel | キャンセルページのパス |

**実装方針:**
- 設定ファイル（YAML/JSON形式）または環境変数で管理
- 設定変更後はシステム再起動で反映
- 設定値のバリデーションを実装（例: タイムアウトは1分以上）

---

## 7. データモデル

### 7.1 予約（reservations）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| reservation_id | VARCHAR(20) | PK | 予約ID（例: QRV-A3F9D2） |
| service_type | VARCHAR(10) | NOT NULL | サービスタイプ（00001, 00002） |
| customer_phone | VARCHAR(20) | NOT NULL | 依頼者電話番号 |
| request_details | TEXT | NOT NULL | 依頼内容（JSON） |
| assigned_shop_id | VARCHAR(20) | FK | 割り当てられた提携店ID |
| confirmed_details | TEXT | | 確定内容（JSON） |
| price | INTEGER | | 料金（円） |
| status | VARCHAR(30) | NOT NULL | ステータス |
| created_at | TIMESTAMP | | 作成日時 |
| updated_at | TIMESTAMP | | 更新日時 |

**ステータス一覧:**
- `pending_confirmation`: SMS確認待ち
- `confirmed`: SMS確認完了
- `calling_shops`: 提携店に電話中
- `reserved`: 仮予約成功
- `payment_pending`: 決済待ち
- `payment_reminder_sent`: 決済リマインダー送信済み
- `paid`: 決済完了（予約確定）
- `cancelled`: キャンセル（依頼者によるキャンセル）
- `cancelled_timeout`: キャンセル（タイムアウト）
- `failed`: 予約失敗

**request_details JSONスキーマ例（時間制サービス）:**
```json
{
  "delivery_address": "東京都渋谷区道玄坂1-2-3",
  "preferred_date": "2025-01-28",
  "time_range": "14:00-17:00",
  "preferred_duration": 60,
  "fallback_duration": 40
}
```

**request_details JSONスキーマ例（サイズオーダー型サービス）:**
```json
{
  "delivery_address": "東京都港区六本木1-1-1",
  "delivery_date": "2025-01-29",
  "orchid_size": "6本立て",
  "stand_message": "祝 開店"
}
```

---

### 7.2 提携店（shops）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| shop_id | VARCHAR(20) | PK | 店舗ID |
| service_type | VARCHAR(10) | NOT NULL | サービスタイプ |
| shop_name | VARCHAR(100) | NOT NULL | 店舗名 |
| phone_number | VARCHAR(20) | NOT NULL | 電話番号 |
| email | VARCHAR(100) | NOT NULL | メールアドレス |
| supported_areas | TEXT | NOT NULL | 対応エリア（JSON配列） |
| score | DECIMAL(5,2) | NOT NULL | スコア（0.00-100.00） |
| phone_reception_start | TIME | NOT NULL | 電話受付開始時刻 |
| phone_reception_end | TIME | NOT NULL | 電話受付終了時刻 |
| created_at | TIMESTAMP | | 作成日時 |
| updated_at | TIMESTAMP | | 更新日時 |

**CSV管理:**
- `data/shops_00001.csv`: Aroma Massage
- `data/shops_00002.csv`: Orchid Delivery

**CSVフォーマット:**
```csv
shop_id,service_type,shop_name,phone_number,email,supported_areas,score,phone_reception_start,phone_reception_end
1,00001,リラックス東京,03-1234-5678,info@relax.jp,"渋谷区,新宿区,港区",85.50,09:00,18:00
2,00001,癒しの森,03-2345-6789,info@iyashi.jp,"渋谷区,世田谷区",82.30,10:00,20:00
```

**各フィールドの説明:**
- `shop_id`: 店舗ID（一意）
- `service_type`: サービスタイプコード（00001/00002）
- `shop_name`: 店舗名（依頼者には非公開）
- `phone_number`: 電話番号
- `email`: メールアドレス
- `supported_areas`: 対応エリア（カンマ区切り）
- `score`: スコア（降順でソート、電話をかける優先順位）
- `phone_reception_start`: 電話受付開始時刻（HH:MM形式）
- `phone_reception_end`: 電話受付終了時刻（HH:MM形式）

---

### 7.3 通話ログ（call_logs）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| call_id | VARCHAR(30) | PK | 通話ID |
| reservation_id | VARCHAR(20) | FK | 予約ID |
| shop_id | VARCHAR(20) | FK | 店舗ID |
| attempt_round | INTEGER | NOT NULL | 試行回数（1周目/2周目） |
| call_status | VARCHAR(20) | NOT NULL | 通話結果 |
| alternative_proposal | TEXT | | 代替案 |
| call_started_at | TIMESTAMP | | 通話開始時刻 |
| call_ended_at | TIMESTAMP | | 通話終了時刻 |
| call_duration_seconds | INTEGER | | 通話時間（秒） |
| recording_url | VARCHAR(200) | | 録音URL |
| notes | TEXT | | メモ |
| created_at | TIMESTAMP | | 作成日時 |

**call_status一覧:**
- `success`: 予約成功
- `no_answer`: 応答なし
- `busy`: 話中
- `time_unavailable`: 時間帯が埋まっている
- `area_unavailable`: エリア対応不可
- `additional_info_required`: 追加情報要求
- `out_of_reception_hours`: 電話受付時間外
- `failed`: その他失敗

---

### 7.4 通知履歴（notifications）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| notification_id | VARCHAR(30) | PK | 通知ID |
| reservation_id | VARCHAR(20) | FK | 予約ID |
| notification_type | VARCHAR(10) | NOT NULL | 通知タイプ（sms/email） |
| recipient | VARCHAR(100) | NOT NULL | 宛先（電話番号/メールアドレス） |
| template_name | VARCHAR(50) | NOT NULL | テンプレート名 |
| content | TEXT | NOT NULL | 送信内容 |
| status | VARCHAR(20) | NOT NULL | 送信ステータス |
| sent_at | TIMESTAMP | | 送信日時 |
| error_message | TEXT | | エラーメッセージ |
| created_at | TIMESTAMP | | 作成日時 |

**template_name一覧:**
- `confirmation_request`: SMS確認リンク
- `payment_link`: 決済リンク
- `payment_confirmed`: 決済完了通知
- `booking_cancelled`: 予約解放通知
- `reminder`: リマインダー
- `booking_failed`: 予約失敗通知
- `payment_reminder`: 決済リマインダー
- `cancellation_confirmation`: キャンセル完了通知

---

### 7.5 確認リンク（confirmation_links）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| confirmation_id | VARCHAR(30) | PK | 確認ID |
| reservation_id | VARCHAR(20) | FK, UNIQUE | 予約ID |
| expires_at | TIMESTAMP | NOT NULL | 有効期限（10分後） |
| confirmed | BOOLEAN | DEFAULT FALSE | 確認済みフラグ |
| confirmed_at | TIMESTAMP | | 確認日時 |
| created_at | TIMESTAMP | | 作成日時 |

---

### 7.6 決済リンク（payment_links）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| payment_id | VARCHAR(30) | PK | 決済ID |
| reservation_id | VARCHAR(20) | FK, UNIQUE | 予約ID |
| stripe_session_id | VARCHAR(100) | | Stripe Session ID |
| expires_at | TIMESTAMP | NOT NULL | 有効期限（10分後） |
| paid | BOOLEAN | DEFAULT FALSE | 決済済みフラグ |
| paid_at | TIMESTAMP | | 決済日時 |
| created_at | TIMESTAMP | | 作成日時 |

---

### 7.7 キャンセルリンク（cancellation_links）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| cancellation_id | VARCHAR(30) | PK | キャンセルID |
| reservation_id | VARCHAR(20) | FK, UNIQUE | 予約ID |
| expires_at | TIMESTAMP | NOT NULL | 有効期限（予約日時の48時間前） |
| cancelled | BOOLEAN | DEFAULT FALSE | キャンセル済みフラグ |
| cancelled_at | TIMESTAMP | | キャンセル日時 |
| refund_status | VARCHAR(20) | | 返金ステータス |
| created_at | TIMESTAMP | | 作成日時 |

---

## 8. 外部連携

### 8.1 Bland.ai（音声AI電話）

**用途:** 提携店への自動音声電話

**料金:**
- 初期費用: なし
- 従量課金: $0.09/分〜
- 無料トライアル: $5分

**API:**
- 電話発信API
- 音声認識・応答
- 録音データ取得

**重要な設計要件:**
- 柔軟な会話フロー: 提携店がスクリプト通りに応答しない場合の処理
- 理解確認: 重要情報（日時、場所等）の復唱確認
- タイムアウト処理: 30秒応答なしで次の店舗へ

---

### 8.2 Twilio（SMS）

**用途:**
- 依頼者へのSMS送信
- 提携店へのSMS送信
- 管理者へのエラー通知SMS

**料金:**
- SMS送信: 約¥10/通

**API:**
- Messages API

---

### 8.3 SendGrid（Email）

**用途:** 提携店へのEmail通知

**料金:**
- 無料枠: 100通/日
- 有料: $19.95/月〜

**API:**
- Send Email API

---

### 8.4 Stripe（決済）

**用途:** オンライン決済

**料金:**
- 初期費用: なし
- 決済手数料: 3.6%

**API:**
- Checkout Session API
- Webhook API

---

### 8.5 MCP（Model Context Protocol）

**用途:** AIエージェントとの連携

**対応クライアント:**
- Claude Desktop
- ChatGPT（MCP対応版）
- その他MCPクライアント

**API:**
- MCPツール: `create_reservation`
- MCPツール: `get_reservation_status`

---

## 9. 制約事項

### 9.1 初期実装での制約

| 項目 | 制約内容 |
|------|---------|
| 対応エリア | 東京23区のみ |
| サービス数 | 2サービス（アロママッサージ、胡蝶蘭配送） |
| 提携店数 | 各サービス5店舗程度 |
| 並列処理 | 10件/分 |
| 管理画面 | コマンドライン/ログファイルのみ |
| 異常系チェック | 依頼確認前のチェックなし |
| キャンセル | 48時間前まで自動対応、以降は手動対応 |

### 9.2 技術的制約

| 項目 | 制約内容 |
|------|---------|
| データベース | SQLite（初期）、PostgreSQL（将来） |
| インフラ | ローカル/Railway/Render |
| 音声AI | Bland.ai（日本語対応必須） |
| 決済 | Stripe（日本での利用可能性） |

### 9.3 サービス対象の制約

| 項目 | 制約内容 |
|------|---------|
| 料金体系 | 時間制またはサイズオーダー型で事前に料金を定義できるサービスのみ対象 |
| 個人情報 | 電話番号のみ保持。その他の個人情報（住所、氏名等）は予約完了後に削除 |
| 対象業種例 | マッサージ（時間制）、花配送（サイズ制）、ケータリング（サイズ/個数制）等 |
| 対象外例 | 見積もりが必要なサービス、カスタムオーダー品等 |

---

### 9.4 提携店との契約前提条件

本システムを運用する上で、提携店との契約時に以下の条件を明記し、合意を得る必要があります。

| 項目 | 前提条件 |
|------|---------|
| 仮予約の扱い | 電話で予約成功後も「仮予約」扱いとし、依頼者が10分以内に決済しない場合は自動キャンセル。仮予約中も他の予約を並行して受け付けて構わない |
| 追加情報の収集制限 | 電話で性別・年齢等の追加情報を要求しない。予約に必要な情報は住所・日時・サービス内容のみ。追加情報が必要な場合はサービス提供時に依頼者と直接確認 |
| キャンセル通知 | 依頼者が48時間前までにキャンセルした場合、即座にSMS/Email通知。キャンセル後は時間枠を解放 |
| トラブル対応 | 依頼者・提携店間のトラブル発生時は、Qualfiaが窓口となり対応 |
| 決済完了通知 | 決済完了通知は最大1分程度かかる場合がある。通知が届くまで時間枠を保持 |
| 電話受付時間 | CSVに記載された電話受付時間内のみ電話をかける。サービス提供時間とは別に設定可能 |

---

## 10. 今後の拡張予定

### 10.1 短期（3ヶ月以内）

#### 10.1.1 サービスタイプの追加
- **花の配送（全種類）**: 胡蝶蘭以外（アレンジメント、花束等）
- **ケータリング**: 弁当配達、会議弁当

#### 10.1.2 機能強化
- **Web管理画面**: Streamlitによる管理画面
- **リアルタイム監視**: ダッシュボード、アラート機能
- **詳細分析**: 予約成功率、店舗別統計

#### 10.1.3 異常系チェック追加
- **エリア制限**: 依頼確認前にエリアチェック
- **時間帯制限**: サービス提供時間帯チェック
- **在庫確認**: 商品在庫の事前確認（胡蝶蘭等）

### 10.2 中期（6-12ヶ月）

#### 10.2.1 対応エリア拡大
- 東京23区 → 東京都全域
- 神奈川県、埼玉県、千葉県へ拡大

#### 10.2.2 多言語対応
- **英語**: 外国人利用者向け
- **中国語**: インバウンド需要

#### 10.2.3 高度な機能
- **AI学習**: 予約成功率向上のための機械学習
- **動的価格設定**: 需給に応じた価格調整
- **ポイント制度**: リピーター優遇

### 10.3 長期（12ヶ月以降）

#### 10.3.1 業種拡大
- **家事代行**: 時間制サービス
- **ハウスクリーニング**: サイズ/時間制サービス
- **美容室予約**: 時間制サービス
- **訪問医療**: 訪問マッサージ、訪問看護等

#### 10.3.2 プラットフォーム化
- **提携店管理ポータル**: 提携店が自身で在庫・スケジュール管理
- **API公開**: 他サービスからのAPI連携
- **ホワイトラベル**: 他社ブランドでのサービス提供

#### 10.3.3 自動化の高度化
- **予測予約**: AIが需要を予測し、事前に提携店と調整
- **動的ルーティング**: 最適な提携店を自動選択
- **完全自律運用**: 人手介入なしでの24時間運用

---

## 11. 用語集

| 用語 | 説明 |
|------|------|
| QRV | Qualfia Reservation（本システムの名称） |
| MCP | Model Context Protocol（AIエージェントとの連携プロトコル） |
| 依頼者 | サービスを利用する一般消費者 |
| 提携店 | サービスを提供する事業者（マッサージ店、花屋等） |
| 予約ID | システムが発行する予約識別子（例: QRV-A3F9D2） |
| サービスタイプ | サービスの種類を識別する番号（00001, 00002） |
| スコア | 提携店の優先順位を示す数値（0.00-100.00） |
| 仮予約 | 提携店と合意済みだが、決済未完了の状態 |
| 予約確定 | 決済完了済みの状態 |
| SMS確認リンク | 依頼者が予約を進めるかを確認するためのリンク |
| 決済リンク | 依頼者が決済を行うためのリンク（Stripe Checkout） |
| リマインダー | 予約日の48時間前と2時間前に送信する通知 |
| 決済リマインダー | 決済リンク送信から5分経過後、未決済の場合に送信するSMS |
| 第1回リマインダー | 予約日時の48時間前に送信するリマインダーSMS |
| 第2回リマインダー | 予約日時の2時間前に送信するリマインダーSMS |
| キャンセルリンク | 依頼者が予約をキャンセルするためのURL（予約日時の48時間前まで有効） |
| 代替案 | 提携店が提示する希望条件外の時間帯等 |
| 通話ログ | 提携店との電話の記録 |
| Opening | 電話スクリプトの冒頭部分（全サービス共通） |
| Requirements | 電話スクリプトの要件伝達部分（サービス固有） |
| Confirmation | 電話スクリプトの確認部分（サービス固有） |
| 設定パラメータ | タイムアウト時間等のシステム設定。設定ファイル（YAML/JSON）または環境変数で管理 |
| 時間制（Time-based） | サービス提供時間に応じて料金が変動する料金体系パターン。1分単位で計算、10分単位で受注 |
| サイズオーダー型（Size-order） | 商品サイズや種類によって料金が固定される料金体系パターン |

---

## 付録

### A. 参考資料
- Bland.ai公式ドキュメント: https://docs.bland.ai
- Stripe API リファレンス: https://stripe.com/docs/api
- Twilio SMS API: https://www.twilio.com/docs/sms
- SendGrid API: https://docs.sendgrid.com
- Model Context Protocol: https://modelcontextprotocol.io

### B. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2025-01-26 | 初版作成 | - |
| 1.1 | 2025-01-26 | プロジェクト名を QR4RX → QRV に変更。花の配送を初期対象に含める | - |
| 1.2 | 2025-01-26 | 個人情報保持を電話番号のみに変更。customer_phoneを全サービス共通項目に。料金体系の制約を追加 | - |
| 1.3 | 2025-01-26 | 依頼者とAIの対話サンプル10例を追加（正常系・エラー対応） | - |
| 1.4 | 2025-01-26 | 予約受付時の検証を簡素化。受付期限チェックと時間範囲チェックを削除し、電話番号形式チェックのみに変更 | - |
| 1.5 | 2025-01-26 | 提携店CSVに電話受付時間フィールドを追加。電話代行処理で受付時間内の店舗のみに電話するよう変更 | - |
| 1.6 | 2025-01-26 | 電話受付時間外の再試行プロセスを削除。受付時間外の場合は即座に依頼者に通知して終了 | - |
| 1.7 | 2025-01-26 | 要件定義_図表.mdを追加。タイミング図、サービスタイプ比較表、概念データモデルを別ファイルで提供 | - |
| 1.8 | 2025-01-26 | 以下の機能追加・修正を実施：<br>・SMS確認期限を5分→10分に延長、設定パラメータ化<br>・MCP経由での予約状況問い合わせ機能追加<br>・決済リマインダー（5分経過時）追加<br>・全店NG時の再依頼プロンプト追加<br>・キャンセル機能の全面改訂（48時間前まで、URL発番）<br>・リマインダーを2回送信（48時間前・2時間前）に変更<br>・2周目の電話を応答なし・話中のみに限定<br>・電話スクリプトに仮予約説明を追加<br>・提携店との契約前提条件を明記<br>・設定パラメータの管理要件を追加（5.6節） | - |
| 1.9 | 2025-01-27 | 要件定義書の全面再構成：<br>・章構成を再編成（4章: 共通仕様、5章: サービスタイプ拡張仕様）<br>・サンプルデータであることを明示（アロママッサージ、胡蝶蘭配送）<br>・タイマッサージを削除、サービスコード再割り当て（00001: アロマ、00002: 胡蝶蘭）<br>・料金体系を2パターンに整理（時間制、サイズオーダー型）<br>・時間制サービスの料金計算を1分単位に変更（受注は10分単位）<br>・対話パターンを汎用化、固定テンプレート依存を排除<br>・SMS/Emailテンプレートを汎用化<br>・外部設計時の注意点を追加（柔軟な会話フロー対応）<br>・TAM（市場規模）記載を削除 | - |

---

**文書終了**

