# QRV マニュアル（運営担当者向け）

**文書バージョン:** 1.0
**作成日:** 2025-01-29
**最終更新日:** 2025-01-29
**対象ユーザー:** Qualfia運営担当者

**関連文書:**
- [運用要件定義書](../1_definition/05_運用要件定義書.md)
- [機能要件定義書](../1_definition/03_機能要件定義書.md)
- [非機能要件定義書](../1_definition/04_非機能要件定義書.md)

---

## 目次

1. [はじめに](#1-はじめに)
2. [日常業務の流れ](#2-日常業務の流れ)
3. [マニュアルオペレーション](#3-マニュアルオペレーション)
4. [ダッシュボード確認](#4-ダッシュボード確認)
5. [Slack通知対応](#5-slack通知対応)
6. [ログ確認方法](#6-ログ確認方法)
7. [インシデント対応](#7-インシデント対応)
8. [定期メンテナンス](#8-定期メンテナンス)

---

## 1. はじめに

### 1.1 本マニュアルについて

本マニュアルは、QRVシステムの運営担当者向けの実務手順書です。日常業務からトラブル対応まで、運営に必要な全ての手順を記載しています。

### 1.2 運営担当者の役割

- システムの監視
- マニュアルオペレーションの実施
- 依頼者・提携店からの問い合わせ対応
- インシデント対応
- 定期メンテナンス

### 1.3 前提知識

運営担当者は以下の知識が必要です：

- QRVシステムの全体像（要件定義書を理解）
- CloudWatch Logsの基本操作
- Slackの使用方法
- 依頼者・提携店向けマニュアルの内容

---

## 2. 日常業務の流れ

### 2.1 始業時（10:00）

#### ステップ1: ダッシュボード確認（5分）

1. **Webブラウザでダッシュボードにアクセス**
   - URL: `https://dashboard.qualfia.com/qrv/`
   - 社内IPからのみアクセス可能

2. **以下の項目を確認**
   - 今日の予約件数（ステータス別）
   - 今日のマニュアルオペレーション件数
   - 昨日の予約成功率
   - 昨日の決済成功率

3. **異常値のチェック**
   - 予約成功率が80%未満 → 原因調査
   - 決済成功率が90%未満 → 原因調査
   - マニュアルオペ件数が通常の2倍以上 → Slack確認

---

#### ステップ2: Slack通知確認（5分）

1. **#qrv-alertsチャンネルを確認**
   - 夜間・早朝の通知がないか確認
   - 未対応の通知があれば優先対応

2. **通知の優先順位**
   - 緊急（赤色）: 即座に対応
   - 高（オレンジ色）: 1時間以内に対応
   - 中（黄色）: 2時間以内に対応
   - 低（緑色）: 24時間以内に対応

---

### 2.2 日中業務（10:00-18:00）

#### 常時監視

- Slackの#qrv-alertsチャンネルを常に開いておく
- 通知が来たら優先度に応じて対応

#### マニュアルオペレーション

- Slack通知に従ってマニュアルオペレーションを実施（詳細は「3. マニュアルオペレーション」を参照）

#### 問い合わせ対応

- inquiry@qualfia.com のメールを確認
- 依頼者・提携店からの問い合わせに対応

---

### 2.3 終業時（18:00）

#### ステップ1: 今日の業務記録（10分）

1. **Notion / Google Sheetsに記録**
   - マニュアルオペレーション件数
   - 問い合わせ件数
   - インシデント件数
   - 特記事項

---

#### ステップ2: 明日の予約確認（5分）

1. **ダッシュボードで明日の予約を確認**
   - 予約件数
   - 特別な対応が必要な予約がないか

---

## 3. マニュアルオペレーション

### 3.1 全店舗予約NGの場合

#### 発生条件

提携店リスト全店舗（2周）で予約が取れなかった場合

#### Slack通知内容

```
【マニュアルオペレーション】全店NG

予約ID: QRV-XXXXXX
サービス: Aroma Massage
日時: 1月30日 14:00-17:00
住所: 東京都渋谷区道玄坂1-2-3
依頼者電話: 080-1234-5678

対応期限: 1時間以内
```

#### 対応手順

**手順1: 予約内容の確認（2分）**

1. ダッシュボードで予約詳細を確認
2. サービスタイプ、日時、場所を把握

**手順2: 対応方針の決定（3分）**

以下のいずれかを選択：

| 対応方針 | 条件 | 所要時間 |
|---------|------|---------|
| **A: 未登録店舗に電話** | 対応可能な店舗が見つかる可能性が高い | 15〜30分 |
| **B: 日時変更を提案** | 時間帯が悪い（夜間、早朝等） | 10〜15分 |
| **C: キャンセル処理** | 依頼者が希望を変えない場合 | 5〜10分 |

**手順3-A: 未登録店舗に電話**

1. CSVに未登録の店舗リストから対応可能店舗を選定
2. 電話で予約内容を伝える
3. 対応可能な店舗が見つかったら:
   - 店舗情報を手動でDBに登録
   - 予約ステータスを `calling_success` に更新
   - 決済リンクを送信
4. 全て断られた場合:
   - **手順3-B**へ

**手順3-B: 日時変更を提案**

1. 依頼者に電話連絡
2. 事情を説明し、別の日時を提案
3. 依頼者が承諾した場合:
   - 予約内容を手動で更新
   - 電話代行を再実行
4. 依頼者が拒否した場合:
   - **手順3-C**へ

**手順3-C: キャンセル処理**

1. 依頼者に電話連絡
2. 事情を説明し、キャンセルの了承を得る
3. 予約ステータスを `failed` に更新
4. 依頼者にSMSで「現在、予約できませんでした」と通知

**手順4: 記録（2分）**

Notion / Google Sheetsに記録：
- 対応内容
- 所要時間
- 結果

---

### 3.2 SMS送信が全リトライ失敗

#### 発生条件

依頼者の電話番号が無効、またはSMS受信拒否設定

#### Slack通知内容

```
【マニュアルオペレーション】SMS送信失敗

予約ID: QRV-XXXXXX
サービス: Aroma Massage
依頼者電話: 080-1234-5678

対応期限: 30分以内（緊急）
```

#### 対応手順

**手順1: 電話番号の確認（2分)**

1. ダッシュボードで登録された電話番号を確認
2. 形式が正しいか確認（例: 090-1234-5678）

**手順2: 依頼者に電話連絡（5分）**

1. 登録電話番号に電話
2. 予約内容を確認し、SMS受信可否を確認
3. SMSが受信できない場合:
   - Emailアドレスを聞く
   - Email経由で決済リンクを送信

**手順3: 決済リンクをEmailで送信（3分）**

1. 手動でEmailを作成
2. 件名: 【Qualfia予約代行】決済リンクのお知らせ（予約ID: QRV-XXXXXX）
3. 本文に予約内容と決済リンクを記載
4. 送信

**手順4: 記録（2分）**

Notion / Google Sheetsに記録

---

### 3.3 決済期限切れ

#### 発生条件

依頼者が決済リンク送信後10分以内に決済を完了しなかった場合

#### Slack通知内容

```
【情報】決済期限切れ

予約ID: QRV-XXXXXX
サービス: Aroma Massage

※自動キャンセル済み。問い合わせがあった場合のみ対応してください。
```

#### 対応手順

**基本的に対応不要**

- 依頼者から問い合わせがあった場合のみ対応
- 問い合わせ内容: 「決済期限が切れました。どうすればいいですか？」

**対応内容:**
1. 事情を確認
2. 再度予約を案内
3. 「最初からAIチャットで予約してください」と伝える

---

### 3.4 提携店からの曖昧な回答

#### 発生条件

電話代行時に提携店が「検討します」「後で連絡します」など曖昧な回答

#### Slack通知内容

```
【マニュアルオペレーション】曖昧な回答

予約ID: QRV-XXXXXX
サービス: Aroma Massage
日時: 1月30日 14:00-17:00
提携店: 〇〇マッサージ店（SHOP-001）
提携店電話: 03-1234-5678

対応期限: 1時間以内
```

#### 対応手順

**手順1: 提携店に電話確認（10分）**

1. 該当提携店に電話
2. 予約内容を再度伝える
3. 明確な回答を取得:
   - **予約OK**: 手動で予約ステータスを `calling_success` に更新 → 決済リンク送信
   - **予約NG**: 次の提携店に電話代行を再開

**手順2: 記録（2分）**

Notion / Google Sheetsに記録

---

### 3.5 提携店からの予約内容変更依頼

#### 発生条件

提携店が「希望時間を30分ずらしてほしい」「サイズを変更してほしい」など変更を要望

#### Slack通知内容

```
【マニュアルオペレーション】変更依頼

予約ID: QRV-XXXXXX
サービス: Aroma Massage
提携店: 〇〇マッサージ店（SHOP-001）
変更内容: 希望時間を15:00→15:30に変更

対応期限: 1時間以内
```

#### 対応手順

**手順1: 依頼者に電話連絡（10分）**

1. 依頼者に電話
2. 変更内容を説明し、承諾を得る

**手順2-A: 承諾した場合（5分）**

1. 予約内容を手動で更新
2. 決済リンクを送信

**手順2-B: 拒否した場合（10分）**

1. 提携店に断りの連絡
2. 次の提携店に電話代行を再開

**手順3: 記録（2分）**

Notion / Google Sheetsに記録

---

### 3.6 キャンセル期限超過後のキャンセル依頼

#### 発生条件

依頼者が予約日時の48時間前を過ぎてからキャンセルを依頼

#### Slack通知内容

```
【マニュアルオペレーション】期限超過キャンセル

予約ID: QRV-XXXXXX
サービス: Aroma Massage
日時: 1月30日 15:00-16:00
キャンセル期限: 1月28日 15:00（超過）

対応期限: 2時間以内
```

#### 対応手順

**手順1: 依頼者の事情を確認（5分）**

1. 依頼者に電話連絡
2. キャンセル理由を確認

**手順2: 判断（2分）**

| 事情 | 対応 |
|------|------|
| **特別な事情あり**（病気、事故等） | 手順3-Aへ |
| **特別な事情なし**（都合が悪くなった等） | 手順3-Bへ |

**手順3-A: 特別な事情がある場合（15分）**

1. 提携店に電話連絡
2. 事情を説明し、キャンセル交渉
3. 提携店が承諾した場合:
   - 手動でキャンセル処理
   - 返金処理を実施
4. 提携店が拒否した場合:
   - 依頼者に説明
   - 返金なし

**手順3-B: 特別な事情がない場合（5分）**

1. 依頼者にキャンセルポリシーを説明
2. 返金なし

**手順4: 記録（2分）**

Notion / Google Sheetsに記録

---

## 4. ダッシュボード確認

### 4.1 ダッシュボードURL

```
https://dashboard.qualfia.com/qrv/
```

**アクセス制限:**
- 社内IPのみアクセス可能
- パスワード認証必須

### 4.2 確認項目

#### 日次確認項目

| 項目 | 確認内容 | 異常値の目安 |
|------|---------|-------------|
| **今日の予約件数** | ステータス別の件数 | 通常の50%未満 or 200%超過 |
| **マニュアルオペレーション件数** | 発生件数 | 予約件数の10%超過 |
| **予約成功率** | (成功件数 / 全予約件数) × 100 | 80%未満 |
| **決済成功率** | (決済完了件数 / 決済試行件数) × 100 | 90%未満 |

#### 週次確認項目

| 項目 | 確認内容 | 異常値の目安 |
|------|---------|-------------|
| **今週の予約推移** | 曜日別の予約件数グラフ | 急激な増減 |
| **キャンセル率** | (キャンセル件数 / 確定予約件数) × 100 | 10%超過 |
| **平均電話発信回数** | 予約成功までの平均店舗数 | 5店舗超過 |

---

## 5. Slack通知対応

### 5.1 #qrv-alertsチャンネル

全ての通知は#qrv-alertsチャンネルに送信されます。

### 5.2 通知の優先度と対応時間

| 優先度 | アラートタイプ | 対応時間目標 | 色 |
|-------|-------------|-------------|---|
| **緊急** | システムダウン、決済システム障害、SMS送信失敗 | 30分以内 | 赤 |
| **高** | 全店予約NG、曖昧な回答 | 1時間以内 | オレンジ |
| **中** | 予約内容変更依頼、キャンセル期限超過 | 2時間以内 | 黄 |
| **低** | 決済期限切れ、一般問い合わせ | 24時間以内 | 緑 |

### 5.3 通知パターン

#### パターン1: マニュアルオペレーション

```
【マニュアルオペレーション】全店NG

予約ID: QRV-XXXXXX
サービス: Aroma Massage
日時: 1月30日 14:00-17:00
住所: 東京都渋谷区道玄坂1-2-3
依頼者電話: 080-1234-5678

対応期限: 1時間以内
```

**対応:** 「3. マニュアルオペレーション」の該当手順に従う

#### パターン2: システムアラート

```
【緊急】CPU使用率が高い状態です

CPU使用率: 85%（5分間継続）
サーバー: qrv-api-server-01

対応期限: 即座
```

**対応:** 「7. インシデント対応」を参照

---

## 6. ログ確認方法

### 6.1 CloudWatch Logsへのアクセス

1. **AWSマネジメントコンソールにログイン**
   - URL: https://console.aws.amazon.com/
   - 認証情報: 運営担当者用のIAMユーザー

2. **CloudWatch Logsを開く**
   - サービス → CloudWatch → ロググループ

3. **QRVのログを選択**
   - `/qrv/mcp-server`
   - `/qrv/api-server`
   - `/qrv/celery-worker`

### 6.2 ログ検索方法

#### 予約IDで検索

```
fields @timestamp, @message
| filter @message like /QRV-XXXXXX/
| sort @timestamp desc
| limit 100
```

#### エラーログの検索

```
fields @timestamp, @message
| filter level = "ERROR"
| sort @timestamp desc
| limit 50
```

#### 特定時間帯のログ検索

```
fields @timestamp, @message
| filter @timestamp >= "2025-01-29T14:00:00Z" and @timestamp <= "2025-01-29T15:00:00Z"
| sort @timestamp desc
```

---

## 7. インシデント対応

### 7.1 Criticalレベル

#### 例: システム全体がダウン

**発生:**
- Pingdomアラート → Slack通知

**初動対応（5分以内）:**
1. ログ確認（CloudWatch Logs）
2. 原因の初期判断（サーバー停止、データベース障害、外部API障害等）

**応急処置（30分以内）:**
1. サーバー再起動
2. 前バージョンへロールバック
3. 一時的な回避策の実施

**復旧確認（45分以内）:**
1. ヘルスチェック確認
2. smoke test実施

**事後対応:**
1. 経営陣に報告
2. ポストモーテム作成（24時間以内）

---

### 7.2 Highレベル

#### 例: Bland.ai障害で電話発信が全く動作しない

**発生:**
- CloudWatch Alarmまたはマニュアルオペ多発で気づく

**初動対応（15分以内）:**
1. ログ確認
2. Bland.aiのステータスページ確認

**応急処置（1時間以内）:**
1. 外部API障害の場合:
   - 復旧を待つ
   - 依頼者に状況説明SMS送信
2. QRV側の問題の場合:
   - コード修正 + デプロイ

**復旧確認（1.5時間以内）:**
1. 機能テスト実施

**事後対応:**
1. 経営陣に報告（2時間以内）
2. インシデントレポート作成（48時間以内）

---

## 8. 定期メンテナンス

### 8.1 日次メンテナンス

**時刻:** 10:00

| 作業 | 所要時間 |
|------|---------|
| ダッシュボード確認 | 5分 |
| Slack通知確認 | 5分 |
| マニュアルオペ対応 | 変動 |

### 8.2 週次メンテナンス

**実施日:** 金曜日

| 作業 | 所要時間 |
|------|---------|
| 週次レポート作成 | 30分 |
| ログ確認 | 30分 |
| 提携店リスト更新（必要に応じて） | 変動 |

### 8.3 月次メンテナンス

**実施日:** 月初5営業日以内

| 作業 | 所要時間 |
|------|---------|
| 月次レポート作成 | 1時間 |
| データベースバックアップ確認 | 15分 |
| 脆弱性スキャン | 30分 |

---

**文書終了**
