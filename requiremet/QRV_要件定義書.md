# QRV (Qualfia Reservation) 要件定義書

**文書バージョン:** 1.6
**作成日:** 2025-01-26
**最終更新日:** 2025-01-26
**プロジェクトコード:** QRV
**プロジェクト名（英語）:** Qualfia Reservation
**プロジェクト名（日本語）:** 未定

---

## 目次

1. [概要](#1-概要)
2. [プロジェクトの目的と背景](#2-プロジェクトの目的と背景)
3. [システム概要](#3-システム概要)
4. [機能要件](#4-機能要件)
5. [非機能要件](#5-非機能要件)
6. [サービスタイプ定義](#6-サービスタイプ定義)
7. [データモデル](#7-データモデル)
8. [外部連携](#8-外部連携)
9. [制約事項](#9-制約事項)
10. [今後の拡張予定](#10-今後の拡張予定)
11. [用語集](#11-用語集)

---

## 1. 概要

### 1.1 プロジェクト概要

QRV（Qualfia Reservation）は、AIエージェントを活用した電話予約代行・決済代行システムです。リラクゼーション領域（出張マッサージ）と花の配送を初期対象とし、将来的にはケータリング、会場予約など多様なサービスへ展開します。

### 1.2 主要機能

- **AIチャット予約受付**: Claude Desktop、ChatGPT等のMCPクライアントから予約依頼を受付
- **自動音声電話代行**: 提携店に自動音声で電話し、予約を確定
- **決済代行**: Stripeを利用したオンライン決済
- **SMS/Email通知**: 依頼者・提携店への自動通知
- **並列処理**: 複数予約の同時処理に対応

### 1.3 提供主体

- **運営会社**: 株式会社Qualfia
- **サービス提供者**: 提携マッサージ店、花屋等（依頼者には店舗名を非公開）

### 1.4 対象ユーザー

- **依頼者**: 個人（出張マッサージ、花の配送等を希望する一般消費者）
- **提携店**: サービス提供事業者（マッサージ店、花屋等）

---

## 2. プロジェクトの目的と背景

### 2.1 目的

1. **電話予約の自動化**: 人手を介さず、AIが自動で電話予約を完結
2. **顧客体験の向上**: チャットベースの簡単な予約フロー
3. **提携店の負荷軽減**: 標準化された予約情報の伝達
4. **スケーラビリティ**: 複数サービスへの展開可能な設計

### 2.2 背景

- リラクゼーション領域の市場規模（TAM: 24,000億円〜）
- 電話予約の煩雑さ（依頼者・提携店双方の負担）
- AI音声技術の成熟（Bland.ai、OpenAI Realtime API等）
- MCP（Model Context Protocol）による汎用的なインターフェース

---

## 3. システム概要

### 3.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│  依頼者                                                      │
│  └─ Claude Desktop / ChatGPT (MCP Client)                   │
└────────────────┬────────────────────────────────────────────┘
                 │ MCP Protocol
                 ▼
┌─────────────────────────────────────────────────────────────┐
│  QRV System                                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ MCP Server (Python)                                  │   │
│  │  - create_reservation                                │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ API Server (FastAPI)                                 │   │
│  │  - 予約管理                                           │   │
│  │  - 決済管理                                           │   │
│  │  - 通知管理                                           │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Task Queue (Celery + Redis)                          │   │
│  │  - 並列予約処理                                        │   │
│  │  - 電話発信タスク                                      │   │
│  │  - 通知送信タスク                                      │   │
│  └──────────────────────────────────────────────────────┘   │
└────┬────────────┬────────────┬────────────┬────────────────┘
     │            │            │            │
     ▼            ▼            ▼            ▼
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐
│ Bland.ai│ │ Twilio  │ │ Stripe  │ │ SQLite/     │
│ (電話)  │ │ (SMS)   │ │ (決済)  │ │ PostgreSQL  │
└─────────┘ └─────────┘ └─────────┘ └─────────────┘
     │            │
     ▼            ▼
┌─────────────────────┐  ┌──────────────┐
│ 提携店              │  │ SendGrid     │
│ (CSV管理)           │  │ (Email)      │
└─────────────────────┘  └──────────────┘
```

### 3.2 処理フロー概要

1. **予約依頼**: 依頼者がMCPクライアントでAIとチャット
2. **SMS確認**: 依頼者の電話番号にSMS送信、5分以内に確認
3. **電話代行**: 提携店に直列で自動音声電話（最大2周）
4. **決済**: 予約成功後、依頼者にSMSで決済リンク送信（10分以内）
5. **確定**: 決済完了で予約確定、依頼者・提携店に通知
6. **リマインダー**: 予約日の24時間前にSMS送信

---

## 4. 機能要件

### 4.1 予約受付機能

#### 4.1.1 チャット予約受付

**機能概要:**
- MCPクライアント（Claude Desktop、ChatGPT等）から予約依頼を受付
- AIエージェントが必要情報を対話的に収集

**入力情報:**
- サービスタイプ（00001: アロママッサージ、00002: タイマッサージ、00003: 胡蝶蘭配送）
- サービス固有の詳細情報（住所、日時、時間、商品等）
- 連絡先電話番号（全サービス共通）

**処理:**
1. サービスタイプに応じた要件定義ファイルを読み込み
2. 必須項目が揃っているかチェック
3. 不足情報をAIが対話で確認
4. 全情報が揃ったら予約内容を依頼者に確認
5. 依頼者が承認したら予約リクエスト作成

**出力:**
- 予約ID（例: QRV-A3F9D2）
- 「SMSで確認リンクを送信します」メッセージ

**エラーケース:**
- サービスタイプが不明: サービス一覧を提示
- 必須情報不足: 不足項目を再度質問
- 電話番号形式エラー: 正しい形式での再入力を依頼

---

#### 4.1.1-1 対話サンプル集

以下、依頼者とAIエージェントの対話例を示します。

##### サンプル1: スムーズな予約（アロママッサージ）

```
[依頼者] 明日の午後、渋谷でアロママッサージを予約したい

[AI] かしこまりました。アロママッサージのご予約ですね。
     以下の情報を教えてください。

     1. 派遣先の住所（渋谷区内の詳細な住所）
     2. 希望の時間帯（例: 14時から17時の間）
     3. 希望の時間（40分〜120分、10分刻み）
     4. 連絡先の電話番号

[依頼者] 渋谷区道玄坂1-2-3、14時から17時の間で1時間、080-1234-5678

[AI] ありがとうございます。確認させてください。

     【予約内容】
     - サービス: アロママッサージ
     - 住所: 東京都渋谷区道玄坂1-2-3
     - 日時: 2025年1月28日 14:00-17:00の間
     - 希望時間: 60分
     - 電話番号: 080-1234-5678

     この内容で予約を進めてよろしいですか？

[依頼者] はい

[AI] 承知しました。予約処理を開始します。

     【予約ID: QRV-A3F9D2】

     まもなく 080-1234-5678 宛にSMSで確認リンクをお送りします。
     5分以内に「進める」ボタンを押してください。

     SMSが送信されるまで本セッションは切らないでください。

[AI] SMSを送信しました。5分以内にご確認ください。
     その後、提携店に電話で予約を取り、結果をSMSでお知らせします。
```

---

##### サンプル2: 情報不足からの会話（タイマッサージ）

```
[依頼者] マッサージ予約したい

[AI] かしこまりました。
     アロママッサージ、タイマッサージ、胡蝶蘭配送がございますが、
     どちらをご希望ですか？

[依頼者] タイマッサージで

[AI] タイマッサージですね。
     以下の情報を教えてください。

     1. 派遣先の住所
     2. 希望の日時
     3. 希望の時間（60分〜120分、10分刻み）
     4. 連絡先の電話番号

[依頼者] 明日の午後、新宿で2時間

[AI] ありがとうございます。いくつか確認させてください。

     - 新宿区内のどちらでしょうか？番地まで詳しく教えてください
     - 明日の午後：具体的に何時から何時の間がご希望ですか？
     - 連絡先の電話番号を教えてください

[依頼者] 新宿区歌舞伎町1-1-1、15時から18時の間、090-9876-5432

[AI] 承知しました。確認させてください。

     【予約内容】
     - サービス: タイマッサージ
     - 住所: 東京都新宿区歌舞伎町1-1-1
     - 日時: 2025年1月28日 15:00-18:00の間
     - 希望時間: 120分
     - 電話番号: 090-9876-5432

     この内容で予約を進めてよろしいですか？

[依頼者] OK

[AI] ありがとうございます。予約処理を開始します。

     【予約ID: QRV-B8K3M1】

     まもなく 090-9876-5432 宛にSMSで確認リンクをお送りします。
     5分以内に「進める」ボタンを押してください。
```

---

##### サンプル3: 情報の修正（胡蝶蘭配送）

```
[依頼者] 胡蝶蘭を配送してほしい

[AI] かしこまりました。胡蝶蘭配送ですね。
     以下の情報を教えてください。

     1. 配送先の住所
     2. 配送希望日
     3. 胡蝶蘭のサイズ（3本立て・6本立て・10本立て）
     4. 立て札の内容
     5. 連絡先の電話番号

[依頼者] 港区六本木1-1-1、明後日、3本立て、「祝 開店」、080-1111-2222

[AI] ありがとうございます。確認させてください。

     【予約内容】
     - サービス: 胡蝶蘭配送
     - 住所: 東京都港区六本木1-1-1
     - 配送日: 2025年1月29日
     - 商品: 3本立て（15,000円）
     - 立て札: 「祝 開店」
     - 電話番号: 080-1111-2222

     この内容で予約を進めてよろしいですか？

[依頼者] やっぱり6本立てに変更で

[AI] 承知しました。6本立て（25,000円）に変更いたします。

     【予約内容】
     - サービス: 胡蝶蘭配送
     - 住所: 東京都港区六本木1-1-1
     - 配送日: 2025年1月29日
     - 商品: 6本立て（25,000円）
     - 立て札: 「祝 開店」
     - 電話番号: 080-1111-2222

     この内容で予約を進めてよろしいですか？

[依頼者] はい

[AI] ありがとうございます。予約処理を開始します。

     【予約ID: QRV-C2T9P5】

     まもなく 080-1111-2222 宛にSMSで確認リンクをお送りします。
```

---

##### サンプル4: 全情報を最初から提供（アロママッサージ）

```
[依頼者] 明日14-17時の間で60分、渋谷区道玄坂1-2-3でアロママッサージ予約、080-1234-5678

[AI] ありがとうございます。全ての情報を確認させてください。

     【予約内容】
     - サービス: アロママッサージ
     - 住所: 東京都渋谷区道玄坂1-2-3
     - 日時: 2025年1月28日 14:00-17:00の間
     - 希望時間: 60分
     - 電話番号: 080-1234-5678

     この内容で予約を進めてよろしいですか？

[依頼者] はい

[AI] 承知しました。予約処理を開始します。

     【予約ID: QRV-D5H1K9】

     まもなく 080-1234-5678 宛にSMSで確認リンクをお送りします。
```

---

##### サンプル5: エラー対応 - サービスタイプ不明

```
[依頼者] 明日、ケータリングを予約したい

[AI] 申し訳ございません。現在、以下のサービスのみ対応しております。

     1. アロママッサージ
     2. タイマッサージ
     3. 胡蝶蘭配送

     ケータリングは将来的に対応予定です。
     上記のサービスでご希望はございますか？

[依頼者] じゃあアロママッサージで

[AI] かしこまりました。アロママッサージですね。
     以下の情報を教えてください。

     1. 派遣先の住所
     2. 希望の時間帯
     3. 希望の時間（40分〜120分）
     4. 連絡先の電話番号
```

---

##### サンプル6: エラー対応 - 電話番号形式エラー

```
[依頼者] 明日14-17時で60分、渋谷区道玄坂1-2-3、アロママッサージ、123-4567

[AI] ありがとうございます。

     電話番号が正しく認識できませんでした。
     携帯電話番号（080/090/070で始まる11桁）を教えてください。

     例: 080-1234-5678 または 08012345678

[依頼者] 080-1234-5678

[AI] ありがとうございます。確認させてください。

     【予約内容】
     - サービス: アロママッサージ
     - 住所: 東京都渋谷区道玄坂1-2-3
     - 日時: 2025年1月28日 14:00-17:00の間
     - 希望時間: 60分
     - 電話番号: 080-1234-5678

     この内容で予約を進めてよろしいですか？
```

---

##### サンプル7: 曖昧な表現の解釈

```
[依頼者] だいたい明日の夕方くらいに渋谷でマッサージ

[AI] かしこまりました。いくつか確認させてください。

     1. マッサージの種類: アロママッサージとタイマッサージがございます。
        どちらをご希望ですか？

     2. 明日の夕方：具体的に何時から何時の間がご希望ですか？
        （例: 17時から20時の間）

     3. 希望の時間: 何分のコースをご希望ですか？
        - アロマ: 40分〜120分
        - タイ: 60分〜120分

[依頼者] アロマで、17-20時の間、1時間くらい

[AI] ありがとうございます。

     - アロママッサージ
     - 明日 17:00-20:00の間
     - 60分

     で承知しました。

     他の情報を教えてください。
     1. 渋谷区内の詳細な住所（番地まで）
     2. 連絡先の電話番号
```

---

##### サンプル8: 複雑な条件（fallback含む）

```
[依頼者] 明日15-18時で1時間のアロママッサージ、難しかったら40分でもいい、
         渋谷区道玄坂1-2-3、080-1234-5678

[AI] ありがとうございます。詳細な条件を承知しました。

     【予約内容】
     - サービス: アロママッサージ
     - 住所: 東京都渋谷区道玄坂1-2-3
     - 日時: 2025年1月28日 15:00-18:00の間
     - 希望時間: 60分（難しい場合は40分）
     - 電話番号: 080-1234-5678

     この内容で予約を進めてよろしいですか？

[依頼者] はい

[AI] 承知しました。予約処理を開始します。

     【予約ID: QRV-F3N7Q2】

     まもなく 080-1234-5678 宛にSMSで確認リンクをお送りします。

     ※ 提携店に電話で確認し、60分が難しい場合は40分で調整いたします。
```

---

#### 4.1.1-2 対話品質のポイント

**良い対話の特徴:**
- 依頼者の意図を正しく理解
- 不足情報を明確に質問
- 確認時に全情報を提示
- 修正要求に柔軟に対応

**避けるべき対話:**
- 曖昧な情報をそのまま受け入れる
- 不足情報を確認せずに進める
- エラー時の代替案を提示しない
- 依頼者の修正要求を無視

---

#### 4.1.2 SMS確認機能

**機能概要:**
- 依頼者の電話番号にSMS送信
- 5分以内に「進める」ボタンを押すと電話代行開始

**処理:**
1. 予約リクエスト作成後、即座にSMS送信（最大3回リトライ）
2. SMS内容: 予約内容 + 「進める」「キャンセル」ボタン付きリンク
3. 依頼者が「進める」押下 → 電話代行タスク開始
4. 依頼者が「キャンセル」押下 → 予約リクエスト削除、通知なし
5. 5分経過で未押下 → 予約リクエスト削除、最初からやり直し

**SMS送信失敗時:**
- 最大3回リトライ
- 全て失敗 → AIチャットで「SMSが送信されるまで本セッションは切らないでください」と表示
- 電話番号確認を促す

---

### 4.2 電話代行機能

#### 4.2.1 提携店選定

**機能概要:**
- サービスタイプに応じた提携店CSVを読み込み
- 対応エリアでフィルタリング
- 電話受付時間内の店舗のみを抽出
- スコア降順でソート

**処理:**
1. `data/shops_{service_type}.csv` を読み込み
2. `supported_areas` に依頼者の住所（区）が含まれる店舗を抽出
3. 現在時刻が `phone_reception_start` 〜 `phone_reception_end` の範囲内の店舗のみを抽出
4. `score`（降順）でソート
5. ソート済みリストを返す

**電話受付時間外の場合:**
- 受付時間内の店舗がない場合は、全店NGとして扱う
- 依頼者にSMSで「現在、受付時間外のため予約できませんでした」と通知
- 予約ステータスを `failed` に更新して処理終了

---

#### 4.2.2 自動音声電話

**機能概要:**
- 提携店に直列で自動音声電話
- 仮予約成功したら終了、全店NGなら2周まで試行

**電話スクリプト構成:**

**1. Opening（全サービス共通）**
```
[AI] こんにちは、Qualfia 電話予約代行です。今お電話可能でしょうか？
[店] はい
[AI] ご担当者はいらっしゃいますか？
[店] ＜担当者に取り次ぎ＞
[AI] ありがとうございます。サービスタイプ番号 {service_type} {service_name}です。
```

**2. Requirements（伝えるべき内容、サービス固有）**
- サービス要件定義ファイルの `requirements_to_communicate` を読み込み
- テンプレートに変数を埋め込んで伝達
- 例（アロママッサージ）:
  ```
  [AI] 1月28日の14時から17時の間で、60分のアロママッサージをお願いしたいのですが、
       難しい場合は40分でも構いません。場所は渋谷区道玄坂1-2-3です。
       ご対応可能でしょうか？
  ```

**3. Confirmation（確認メッセージ、サービス固有）**
- サービス要件定義ファイルの `confirmation_messages` を読み込み
- テンプレートに変数を埋め込んで確認
- 例:
  ```
  [AI] それでは、1月28日15時から60分で間違いないでしょうか？
  [店] はい
  [AI] 場所は渋谷区道玄坂1-2-3で承知しました。
       予約番号はQRV-A3F9D2です。
       後ほどSMSとメールで詳細をお送りいたします。
       10分以内にお客様が決済されない場合は、キャンセルとなりますのでご了承ください。
  ```

**店側の応答パターン:**

| 応答 | 処理 |
|------|------|
| 予約成功 | 通話ログ記録、次の処理へ |
| 時間帯が埋まっている | 代替案があれば記録、次の店へ |
| エリア対応不可 | 通話ログ記録、次の店へ |
| 電話に出ない（30秒） | 通話ログ記録、次の店へ |
| 追加情報要求（性別等） | 「詳細はお客様と直接」と回答、対応不可なら次の店へ |
| 時間外提案（希望外） | 代替案として記録、次の店へ |
| 時間短縮提案（60分→40分等） | 代替案として記録、次の店へ |

**リトライロジック:**
- 1周目: 全提携店に順次電話
- 全店NG → すぐに2周目開始
- 2周目: 再度全提携店に順次電話
- 2周目も全店NG → 全店NG処理へ

**通話ログ記録:**
- 予約ID、店舗ID、試行回数（1周目/2周目）
- 通話結果（成功/不可/応答なし/エリア外等）
- 代替案（時間外提案等）
- 通話時間

---

#### 4.2.3 全店NG時の処理

**機能概要:**
- 2周しても全店NGの場合、依頼者に代替案を提示

**処理:**
1. 通話ログから代替案を抽出
2. 代替可能な時間帯をまとめる
3. 依頼者にSMS送信

**SMS内容:**
```
【Qualfia予約代行】

申し訳ございません。
ご希望の条件で予約できませんでした。

■ ご依頼内容
日時: 1月28日 14:00-17:00の間
サービス: アロママッサージ 60分
住所: 東京都渋谷区道玄坂1-2-3

■ 代替可能な時間帯
以下の時間帯でしたら予約可能な見込みです：
- 1月28日 18:00以降

時間帯を変更して再度ご依頼ください。
```

---

### 4.3 決済機能

#### 4.3.1 決済リンク送信

**機能概要:**
- 仮予約成功後、依頼者にSMSで決済リンク送信
- 10分以内に決済完了で予約確定

**処理:**
1. 料金計算（サービスタイプに応じた計算ロジック）
2. Stripe Checkout Session作成
3. 依頼者にSMS送信（最大3回リトライ）
4. 提携店にもSMS/Email送信

**依頼者へのSMS:**
```
【Qualfia予約代行】予約が完了しました。

■ 予約内容
予約ID: QRV-A3F9D2
サービス: アロママッサージ
日時: 1月28日(火) 15:00-16:00
住所: 東京都渋谷区道玄坂1-2-3
料金: 8,200円

10分以内に以下のリンクから決済してください。
https://qualfia.com/phone/book/QRV-A3F9D2
```

**提携店へのSMS:**
```
【Qualfia予約代行】予約が確定しました。

予約ID: QRV-A3F9D2
日時: 1月28日(火) 15:00-16:00
サービス: アロママッサージ 60分
住所: 東京都渋谷区道玄坂1-2-3
お客様電話: 080-1234-5678
料金: 8,200円（決済待ち）

10分以内にお客様が決済されない場合は、キャンセルとなります。
決済完了後、再度ご連絡いたします。
```

**SMS送信失敗時:**
- 最大3回リトライ
- 全て失敗 → 予約を自動キャンセル、提携店にも通知

---

#### 4.3.2 決済処理

**機能概要:**
- Stripe Checkoutで決済処理
- 10分のタイムアウト監視

**処理:**
1. 依頼者が決済リンクをクリック
2. Stripe Checkoutページ表示
3. 決済完了 → Webhookで通知受信
4. 予約ステータスを「paid」に更新
5. 依頼者・提携店に確定SMS送信

**依頼者への決済完了SMS:**
```
【Qualfia予約代行】決済が完了しました。予約が確定しました。

■ 予約内容
予約ID: QRV-A3F9D2
サービス: アロママッサージ
日時: 1月28日(火) 15:00-16:00
住所: 東京都渋谷区道玄坂1-2-3
料金: 8,200円（決済済み）

当日は担当者が直接お伺いします。
前日にリマインダーSMSをお送りします。
```

**提携店への決済完了SMS:**
```
【Qualfia予約代行】お客様の決済が完了しました。予約が確定しました。

予約ID: QRV-A3F9D2
日時: 1月28日(火) 15:00-16:00
サービス: アロママッサージ 60分
住所: 東京都渋谷区道玄坂1-2-3
お客様電話: 080-1234-5678
料金: 8,200円（決済済み）

前日にリマインダーSMSをお送りします。
```

**10分タイムアウト時:**
1. 決済未完了を検知
2. 予約を自動解放
3. 依頼者・提携店にリリース通知SMS送信

**依頼者へのリリース通知:**
```
【Qualfia予約代行】

予約ID: QRV-A3F9D2

10分以内に決済が完了しなかったため、予約を解放しました。
再度予約をご希望の場合は、AIエージェント経由でお願いします。
```

**提携店へのリリース通知:**
```
【Qualfia予約代行】

予約ID: QRV-A3F9D2

お客様の決済が完了しなかったため、予約をキャンセルいたしました。
```

---

### 4.4 通知機能

#### 4.4.1 リマインダー送信

**機能概要:**
- 予約日の24時間前にSMS送信

**依頼者へのリマインダー:**
```
【Qualfia予約代行】明日の予約のリマインダーです。

予約ID: QRV-A3F9D2
日時: 1月28日(火) 15:00-16:00
サービス: アロママッサージ 60分
住所: 東京都渋谷区道玄坂1-2-3

担当者が直接お伺いします。
```

**提携店へのリマインダー:**
```
【Qualfia予約代行】明日の予約のリマインダーです。

予約ID: QRV-A3F9D2
日時: 1月28日(火) 15:00-16:00
サービス: アロママッサージ 60分
住所: 東京都渋谷区道玄坂1-2-3
お客様電話: 080-1234-5678
```

**実装:**
- Celery Beatで定期実行（例: 毎時0分）
- 予約日時の24時間前に該当する予約を抽出
- SMS送信（リトライ3回、失敗時はログ記録のみ）

---

#### 4.4.2 Email通知

**機能概要:**
- 提携店にEmail通知（SMSの補助）

**送信タイミング:**
- 仮予約成功時
- 決済完了時
- 予約解放時

**内容:**
- SMSと同等の情報をHTML形式で送信

---

### 4.5 管理機能

#### 4.5.1 管理画面（初期MVP）

**機能概要:**
- コマンドライン/ログファイルで確認

**確認項目:**
- 予約一覧（予約ID、依頼者電話番号、提携店、ステータス）
- 決済状況
- 提携店リスト
- システムログ

**将来実装予定:**
- Web管理画面（Streamlit等）

---

### 4.6 キャンセル機能

#### 4.6.1 キャンセルポリシー

**原則:** 決済完了後はキャンセル不可

**例外対応:**
- 急遽キャンセルが必要な場合: inquiry@qualfia.com にメール連絡
- 現時点では手動対応

**将来実装予定:**
- 自動キャンセル処理（一定条件下）
- キャンセル料の設定

---

## 5. 非機能要件

### 5.1 性能要件

| 項目 | 要件 |
|------|------|
| 予約処理時間 | 依頼受付から決済リンク送信まで5分以内 |
| 電話応答時間 | 呼び出し30秒で応答なしと判定 |
| SMS送信時間 | 3秒以内（リトライ除く） |
| 同時並列予約 | 初期: 10件/分、将来: 100件/分 |

### 5.2 可用性要件

| 項目 | 要件 |
|------|------|
| システム稼働率 | 99.0%（初期）、99.9%（将来） |
| メンテナンス時間 | 月次、深夜帯（2:00-4:00） |

### 5.3 拡張性要件

| 項目 | 要件 |
|------|------|
| サービスタイプ追加 | コード修正なしで設定ファイルのみで追加可能 |
| 提携店追加 | CSV追加のみで可能 |
| 並列処理スケール | 負荷に応じてCeleryワーカー数を増減可能 |

### 5.4 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 個人情報保護 | 電話番号のみ保持。住所等は予約完了後に削除 |
| 決済情報 | Stripeに委託、自システムでは保持しない |
| API認証 | MCP接続時に認証トークン必須 |
| ログ管理 | システムログは30日間保存（個人情報は含めない） |

### 5.5 運用要件

| 項目 | 要件 |
|------|------|
| エラー通知 | 管理者に即座にSMS通知（080-5496-0516） |
| バックアップ | 毎日深夜にDB自動バックアップ |
| ログ保存 | システムログは30日間保存 |

---

## 6. サービスタイプ定義

### 6.1 Type 00001: Aroma Massage（アロママッサージ）

#### 基本情報
- **サービスコード:** 00001
- **サービス名:** Aroma Massage
- **表示名:** アロママッサージ
- **対応エリア:** 東京23区
- **受付期限:** 最短24時間前、最長30日先

#### 確認項目

**共通項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| customer_phone | 必須 | 連絡先の電話番号を教えてください |

**サービス固有項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| delivery_address | 必須 | 派遣先の住所を教えてください（例: 東京都渋谷区道玄坂1-2-3） |
| preferred_date | 必須 | 希望の日付を教えてください（例: 明日、1月28日） |
| time_range | 必須 | 希望の時間帯を教えてください（例: 14時から17時の間） |
| preferred_duration | 必須 | 希望の時間を教えてください（40分〜120分、10分刻み） |
| fallback_duration | 任意 | 難しい場合の代替時間はありますか？ |

#### 料金体系
- **ベース料金:** 1,000円
- **通常時間帯（6:00-22:00）:** 1,200円/10分
- **深夜時間帯（22:00-6:00）:** 1,500円/10分
- **計算例:** 21:30開始60分の場合
  - 21:30-22:00（30分 = 3単位）: 1,200円 × 3 = 3,600円
  - 22:00-22:30（30分 = 3単位）: 1,500円 × 3 = 4,500円
  - 合計: 1,000円 + 3,600円 + 4,500円 = 9,100円

#### 電話スクリプト（Requirements）
```
{date}の{time_range}で、{preferred_duration}分のアロママッサージをお願いしたいのですが、
難しい場合は{fallback_duration}分でも構いません。
場所は{address}です。ご対応可能でしょうか？
```

---

### 6.2 Type 00002: Thai Massage（タイマッサージ）

#### 基本情報
- **サービスコード:** 00002
- **サービス名:** Thai Massage
- **表示名:** タイマッサージ
- **対応エリア:** 東京23区
- **受付期限:** 最短24時間前、最長30日先

#### 確認項目

**共通項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| customer_phone | 必須 | 連絡先の電話番号を教えてください |

**サービス固有項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| delivery_address | 必須 | 派遣先の住所を教えてください |
| preferred_date | 必須 | 希望の日付を教えてください |
| time_range | 必須 | 希望の時間帯を教えてください |
| preferred_duration | 必須 | 希望の時間を教えてください（60分〜120分、10分刻み） |
| fallback_duration | 任意 | 難しい場合の代替時間はありますか？ |

#### 料金体系
- **ベース料金:** 1,000円
- **通常時間帯（6:00-22:00）:** 1,300円/10分
- **深夜時間帯（22:00-6:00）:** 1,600円/10分

#### 電話スクリプト（Requirements）
```
{date}の{time_range}で、{preferred_duration}分のタイマッサージをお願いしたいのですが、
難しい場合は{fallback_duration}分でも構いません。
場所は{address}です。ご対応可能でしょうか？
```

---

### 6.3 Type 00003: Orchid Delivery（胡蝶蘭配送）

#### 基本情報
- **サービスコード:** 00003
- **サービス名:** Orchid Delivery
- **表示名:** 胡蝶蘭配送
- **対応エリア:** 東京23区
- **受付期限:** 最短24時間前、最長30日先

#### 確認項目

**共通項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| customer_phone | 必須 | 連絡先の電話番号を教えてください |

**サービス固有項目:**
| 項目 | 必須/任意 | プロンプト例 |
|------|----------|-------------|
| delivery_address | 必須 | 配送先の住所を教えてください |
| delivery_date | 必須 | 配送希望日を教えてください（例: 明日、1月28日） |
| orchid_size | 必須 | 胡蝶蘭のサイズを選んでください：<br>1. 3本立て（15,000円）<br>2. 6本立て（25,000円）<br>3. 10本立て（30,000円） |
| stand_message | 必須 | 立て札の内容を教えてください（例: 祝 開店、お祝い） |

#### 料金体系
- **3本立て:** 15,000円（配送料込み）
- **6本立て:** 25,000円（配送料込み）
- **10本立て:** 30,000円（配送料込み）

**注:** 胡蝶蘭配送は商品サイズによる固定料金制。事前に料金が確定している。

#### 電話スクリプト（Requirements）
```
{delivery_date}に{address}へ、{orchid_size}の胡蝶蘭の配送をお願いしたいのですが、
立て札は「{stand_message}」でお願いします。ご対応可能でしょうか？
```

---

## 7. データモデル

### 7.1 予約（reservations）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| reservation_id | VARCHAR(20) | PK | 予約ID（例: QRV-A3F9D2） |
| service_type | VARCHAR(10) | NOT NULL | サービスタイプ（00001, 00002, 00003） |
| customer_phone | VARCHAR(20) | NOT NULL | 依頼者電話番号 |
| request_details | TEXT | NOT NULL | 依頼内容（JSON） |
| assigned_shop_id | VARCHAR(20) | FK | 割り当てられた提携店ID |
| confirmed_details | TEXT | | 確定内容（JSON） |
| price | INTEGER | | 料金（円） |
| status | VARCHAR(30) | NOT NULL | ステータス |
| created_at | TIMESTAMP | | 作成日時 |
| updated_at | TIMESTAMP | | 更新日時 |

**ステータス一覧:**
- `pending_confirmation`: SMS確認待ち
- `confirmed`: SMS確認完了
- `calling_shops`: 提携店に電話中
- `reserved`: 仮予約成功
- `payment_pending`: 決済待ち
- `paid`: 決済完了（予約確定）
- `cancelled`: キャンセル
- `failed`: 予約失敗

---

### 7.2 提携店（shops）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| shop_id | VARCHAR(20) | PK | 店舗ID |
| service_type | VARCHAR(10) | NOT NULL | サービスタイプ |
| shop_name | VARCHAR(100) | NOT NULL | 店舗名 |
| phone_number | VARCHAR(20) | NOT NULL | 電話番号 |
| email | VARCHAR(100) | NOT NULL | メールアドレス |
| supported_areas | TEXT | NOT NULL | 対応エリア（JSON配列） |
| score | DECIMAL(5,2) | NOT NULL | スコア（0.00-100.00） |
| created_at | TIMESTAMP | | 作成日時 |
| updated_at | TIMESTAMP | | 更新日時 |

**CSV管理:**
- `data/shops_00001.csv`: Aroma Massage
- `data/shops_00002.csv`: Thai Massage
- `data/shops_00003.csv`: Orchid Delivery

**CSVフォーマット:**
```csv
shop_id,service_type,shop_name,phone_number,email,supported_areas,score,phone_reception_start,phone_reception_end
1,00001,リラックス東京,03-1234-5678,info@relax.jp,"渋谷区,新宿区,港区",85.50,09:00,18:00
2,00001,癒しの森,03-2345-6789,info@iyashi.jp,"渋谷区,世田谷区",82.30,10:00,20:00
```

**各フィールドの説明:**
- `shop_id`: 店舗ID（一意）
- `service_type`: サービスタイプコード（00001/00002/00003）
- `shop_name`: 店舗名（依頼者には非公開）
- `phone_number`: 電話番号
- `email`: メールアドレス
- `supported_areas`: 対応エリア（カンマ区切り）
- `score`: スコア（降順でソート、電話をかける優先順位）
- `phone_reception_start`: 電話受付開始時刻（HH:MM形式）
- `phone_reception_end`: 電話受付終了時刻（HH:MM形式）

---

### 7.3 通話ログ（call_logs）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| call_id | VARCHAR(30) | PK | 通話ID |
| reservation_id | VARCHAR(20) | FK | 予約ID |
| shop_id | VARCHAR(20) | FK | 店舗ID |
| attempt_round | INTEGER | NOT NULL | 試行回数（1周目/2周目） |
| call_status | VARCHAR(20) | NOT NULL | 通話結果 |
| alternative_proposal | TEXT | | 代替案 |
| call_started_at | TIMESTAMP | | 通話開始時刻 |
| call_ended_at | TIMESTAMP | | 通話終了時刻 |
| call_duration_seconds | INTEGER | | 通話時間（秒） |
| recording_url | VARCHAR(200) | | 録音URL |
| notes | TEXT | | メモ |
| created_at | TIMESTAMP | | 作成日時 |

**call_status一覧:**
- `success`: 予約成功
- `no_answer`: 応答なし
- `busy`: 話中
- `time_unavailable`: 時間帯が埋まっている
- `area_unavailable`: エリア対応不可
- `additional_info_required`: 追加情報要求
- `out_of_reception_hours`: 電話受付時間外（全店舗、再試行なし）
- `failed`: その他失敗

---

### 7.4 通知履歴（notifications）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| notification_id | VARCHAR(30) | PK | 通知ID |
| reservation_id | VARCHAR(20) | FK | 予約ID |
| notification_type | VARCHAR(10) | NOT NULL | 通知タイプ（sms/email） |
| recipient | VARCHAR(100) | NOT NULL | 宛先（電話番号/メールアドレス） |
| template_name | VARCHAR(50) | NOT NULL | テンプレート名 |
| content | TEXT | NOT NULL | 送信内容 |
| status | VARCHAR(20) | NOT NULL | 送信ステータス |
| sent_at | TIMESTAMP | | 送信日時 |
| error_message | TEXT | | エラーメッセージ |
| created_at | TIMESTAMP | | 作成日時 |

**template_name一覧:**
- `confirmation_request`: SMS確認リンク
- `payment_link`: 決済リンク
- `payment_confirmed`: 決済完了通知
- `booking_cancelled`: 予約解放通知
- `reminder`: リマインダー
- `booking_failed`: 予約失敗通知

---

### 7.5 確認リンク（confirmation_links）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| confirmation_id | VARCHAR(30) | PK | 確認ID |
| reservation_id | VARCHAR(20) | FK, UNIQUE | 予約ID |
| expires_at | TIMESTAMP | NOT NULL | 有効期限（5分後） |
| confirmed | BOOLEAN | DEFAULT FALSE | 確認済みフラグ |
| confirmed_at | TIMESTAMP | | 確認日時 |
| created_at | TIMESTAMP | | 作成日時 |

---

### 7.6 決済リンク（payment_links）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| payment_id | VARCHAR(30) | PK | 決済ID |
| reservation_id | VARCHAR(20) | FK, UNIQUE | 予約ID |
| stripe_session_id | VARCHAR(100) | | Stripe Session ID |
| expires_at | TIMESTAMP | NOT NULL | 有効期限（10分後） |
| paid | BOOLEAN | DEFAULT FALSE | 決済済みフラグ |
| paid_at | TIMESTAMP | | 決済日時 |
| created_at | TIMESTAMP | | 作成日時 |

---

## 8. 外部連携

### 8.1 Bland.ai（音声AI電話）

**用途:** 提携店への自動音声電話

**料金:**
- 初期費用: なし
- 従量課金: $0.09/分〜
- 無料トライアル: $5分

**API:**
- 電話発信API
- 音声認識・応答
- 録音データ取得

---

### 8.2 Twilio（SMS）

**用途:**
- 依頼者へのSMS送信
- 提携店へのSMS送信
- 管理者へのエラー通知SMS

**料金:**
- SMS送信: 約¥10/通

**API:**
- Messages API

---

### 8.3 SendGrid（Email）

**用途:** 提携店へのEmail通知

**料金:**
- 無料枠: 100通/日
- 有料: $19.95/月〜

**API:**
- Send Email API

---

### 8.4 Stripe（決済）

**用途:** オンライン決済

**料金:**
- 初期費用: なし
- 決済手数料: 3.6%

**API:**
- Checkout Session API
- Webhook API

---

### 8.5 MCP（Model Context Protocol）

**用途:** AIエージェントとの連携

**対応クライアント:**
- Claude Desktop
- ChatGPT（MCP対応版）
- その他MCPクライアント

**API:**
- MCPツール: `create_reservation`

---

## 9. 制約事項

### 9.1 初期実装での制約

| 項目 | 制約内容 |
|------|---------|
| 対応エリア | 東京23区のみ |
| サービス数 | 3サービス（マッサージ2種、胡蝶蘭1種） |
| 提携店数 | 各サービス5店舗程度 |
| 並列処理 | 10件/分 |
| 管理画面 | コマンドライン/ログファイルのみ |
| 異常系チェック | 依頼確認前のチェックなし |
| キャンセル | 手動対応のみ |

### 9.2 技術的制約

| 項目 | 制約内容 |
|------|---------|
| データベース | SQLite（初期）、PostgreSQL（将来） |
| インフラ | ローカル/Railway/Render |
| 音声AI | Bland.ai（日本語対応必須） |
| 決済 | Stripe（日本での利用可能性） |

### 9.3 サービス対象の制約

| 項目 | 制約内容 |
|------|---------|
| 料金体系 | Tシャツサイズ（S/M/L等）または時間で事前に料金を定義できるサービスのみ対象 |
| 個人情報 | 電話番号のみ保持。その他の個人情報（住所、氏名等）は予約完了後に削除 |
| 対象業種例 | マッサージ（時間制）、花配送（サイズ制）、ケータリング（サイズ/個数制）等 |
| 対象外例 | 見積もりが必要なサービス、カスタムオーダー品等 |

---

## 10. 今後の拡張予定

### 10.1 短期（3-6ヶ月）

#### 10.1.1 サービス拡大
- **花の配送（全種類）**: 胡蝶蘭以外（アレンジメント、花束等）
- **ケータリング**: 弁当配達、会議弁当
- **会場予約**: レンタルスペース、会議室

#### 10.1.2 機能強化
- **Web管理画面**: Streamlitによる管理画面
- **リアルタイム監視**: ダッシュボード、アラート機能
- **詳細分析**: 予約成功率、店舗別統計

#### 10.1.3 異常系チェック追加
- **エリア制限**: 依頼確認前にエリアチェック
- **時間帯制限**: サービス提供時間帯チェック
- **在庫確認**: 商品在庫の事前確認（胡蝶蘭等）

### 10.2 中期（6-12ヶ月）

#### 10.2.1 対応エリア拡大
- **東京23区外**: 多摩地域、神奈川、千葉、埼玉
- **全国展開**: 主要都市（大阪、名古屋、福岡等）

#### 10.2.2 多言語対応
- **英語**: 外国人利用者向け
- **中国語**: インバウンド需要

#### 10.2.3 高度な機能
- **AI学習**: 予約成功率向上のための機械学習
- **動的価格設定**: 需給に応じた価格調整
- **ポイント制度**: リピーター優遇

### 10.3 長期（12ヶ月以降）

#### 10.3.1 業種拡大
- **家事代行**: 市場規模24,000億円
- **ハウスクリーニング**: 市場規模7,500億円
- **美容室予約**: 市場規模4,160億円
- **訪問医療**: 訪問マッサージ、訪問看護等

#### 10.3.2 プラットフォーム化
- **提携店管理ポータル**: 提携店が自身で在庫・スケジュール管理
- **API公開**: 他サービスからのAPI連携
- **ホワイトラベル**: 他社ブランドでのサービス提供

#### 10.3.3 自動化の高度化
- **予測予約**: AIが需要を予測し、事前に提携店と調整
- **動的ルーティング**: 最適な提携店を自動選択
- **完全自律運用**: 人手介入なしでの24時間運用

---

## 11. 用語集

| 用語 | 説明 |
|------|------|
| QRV | Qualfia Reservation（本システムの名称） |
| MCP | Model Context Protocol（AIエージェントとの連携プロトコル） |
| 依頼者 | サービスを利用する一般消費者 |
| 提携店 | サービスを提供する事業者（マッサージ店、花屋等） |
| 予約ID | システムが発行する予約識別子（例: QRV-A3F9D2） |
| サービスタイプ | サービスの種類を識別する番号（00001, 00002, 00003） |
| スコア | 提携店の優先順位を示す数値（0.00-100.00） |
| 仮予約 | 提携店と合意済みだが、決済未完了の状態 |
| 予約確定 | 決済完了済みの状態 |
| SMS確認リンク | 依頼者が予約を進めるかを確認するためのリンク |
| 決済リンク | 依頼者が決済を行うためのリンク（Stripe Checkout） |
| リマインダー | 予約日の24時間前に送信する通知 |
| 代替案 | 提携店が提示する希望条件外の時間帯等 |
| 通話ログ | 提携店との電話の記録 |
| Opening | 電話スクリプトの冒頭部分（全サービス共通） |
| Requirements | 電話スクリプトの要件伝達部分（サービス固有） |
| Confirmation | 電話スクリプトの確認部分（サービス固有） |

---

## 付録

### A. 参考資料
- Bland.ai公式ドキュメント: https://docs.bland.ai
- Stripe API リファレンス: https://stripe.com/docs/api
- Twilio SMS API: https://www.twilio.com/docs/sms
- SendGrid API: https://docs.sendgrid.com
- Model Context Protocol: https://modelcontextprotocol.io

### B. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2025-01-26 | 初版作成 | - |
| 1.1 | 2025-01-26 | プロジェクト名を QR4RX → QRV に変更。花の配送を初期対象に含める | - |
| 1.2 | 2025-01-26 | 個人情報保持を電話番号のみに変更。customer_phoneを全サービス共通項目に。料金体系の制約を追加 | - |
| 1.3 | 2025-01-26 | 依頼者とAIの対話サンプル10例を追加（正常系・エラー対応） | - |
| 1.4 | 2025-01-26 | 予約受付時の検証を簡素化。受付期限チェックと時間範囲チェックを削除し、電話番号形式チェックのみに変更 | - |
| 1.5 | 2025-01-26 | 提携店CSVに電話受付時間フィールドを追加。電話代行処理で受付時間内の店舗のみに電話するよう変更 | - |
| 1.6 | 2025-01-26 | 電話受付時間外の再試行プロセスを削除。受付時間外の場合は即座に依頼者に通知して終了 | - |

---

**文書終了**
