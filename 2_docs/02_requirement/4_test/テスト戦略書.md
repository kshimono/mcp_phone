# QRV テスト戦略書

**文書バージョン:** 1.1
**作成日:** 2025-01-27
**最終更新日:** 2025-01-28
**プロジェクトコード:** QRV
**関連文書:** [要件定義書.md](要件定義書.md) v2.1

---

## 目次

1. [概要](#1-概要)
2. [テスト方針](#2-テスト方針)
3. [テストレベル](#3-テストレベル)
4. [テスト環境](#4-テスト環境)
5. [テスト実施スケジュール](#5-テスト実施スケジュール)
6. [リスク管理](#6-リスク管理)

---

## 1. 概要

### 1.1 目的

本テスト戦略書は、QRV（Qualfia Reservation）システムのテスト活動全体の方針と計画を定義します。テスト駆動型開発（TDD）のアプローチに基づき、要件定義フェーズから受け入れ基準を明確化し、各開発フェーズで適切なテストを実施します。

### 1.2 対象システム

- **システム名:** QRV（Qualfia Reservation）
- **概要:** AIエージェントを活用した電話予約代行・決済代行システム
- **主要機能:**
  - AIチャット予約受付
  - SMS確認・通知
  - 自動音声電話代行
  - 決済代行
  - キャンセル処理

### 1.3 テスト対象範囲

| カテゴリ | 対象 |
|---------|------|
| 機能要件 | 予約受付、電話代行、決済、通知、キャンセル |
| 非機能要件 | 性能、セキュリティ、可用性 |
| 外部連携 | Bland.ai、Twilio、Stripe、SendGrid、MCP |
| サービスタイプ | 時間制サービス（アロママッサージ）、サイズオーダー型（胡蝶蘭配送） |

---

## 2. テスト方針

### 2.1 基本方針

1. **テスト駆動型開発（TDD）の採用**
   - 実装前にテストケースを定義
   - Red → Green → Refactorサイクルの実践
   - ユニットテストのカバレッジ目標: 80%以上

2. **受け入れテスト優先**
   - 要件定義フェーズで受け入れ基準を明確化
   - ビジネス価値の検証を優先

3. **外部連携のモック化**
   - 初期段階では外部API（Bland.ai、Twilio等）をモック化
   - 統合テストフェーズで実際のAPIを使用

4. **段階的なテスト実施**
   - 各フェーズで適切なレベルのテストを実施
   - 早期にバグを検出し、修正コストを最小化

### 2.2 品質目標

| 指標 | 目標値 |
|------|--------|
| ユニットテストカバレッジ | 80%以上 |
| 受け入れテスト合格率 | 100% |
| 重大バグ（Critical） | 0件 |
| 中程度バグ（Major） | リリース前に全て解決 |
| 軽微バグ（Minor） | 10件以下 |

---

## 3. テストレベル

### 3.1 受け入れテスト（Acceptance Test）

**目的:** ビジネス要件を満たすかを検証

**実施者:** プロダクトオーナー、開発チーム

**実施タイミング:** 各機能実装完了後、リリース前

**テスト内容:**
- 各機能要件の受け入れ基準に基づく検証
- エンドツーエンドの業務フロー確認
- ユーザーストーリーごとの検証

**成功基準:**
- 要件定義書の受け入れ基準を全て満たすこと

**テストケース数（想定）:**
- 予約受付機能: 5項目
- 電話代行機能: 5項目
- 決済機能: 4項目
- 通知機能: 3項目
- キャンセル機能: 3項目
- **合計: 約20項目**

### 3.2 統合テスト（Integration Test）

**目的:** コンポーネント間の連携を検証

**実施者:** 開発チーム

**実施タイミング:** 実装フェーズ中、各統合ポイント完成時

**テスト内容:**
- MCP Server ↔ API Server間の連携
- API Server ↔ 外部サービス間の連携
- Task Queue（Celery）の動作確認
- データベース連携

**成功基準:**
- コンポーネント間のデータ受け渡しが正常に動作すること
- エラーハンドリングが適切に機能すること

**テストケース数（想定）:**
- 内部連携: 10項目
- 外部連携（Bland.ai、Twilio、Stripe等）: 15項目
- **合計: 約25項目**

### 3.3 ユニットテスト（Unit Test）

**目的:** 個別のモジュール・関数の正常性を検証

**実施者:** 開発者

**実施タイミング:** 実装フェーズ（TDDサイクル）

**テスト内容:**
- 各関数の正常系・異常系
- 境界値テスト
- エラーハンドリング

**成功基準:**
- 全てのテストケースが合格すること
- コードカバレッジ80%以上

**テストケース数（想定）:**
- コアロジック: 50-100項目

### 3.4 非機能テスト

**目的:** 性能、セキュリティ、可用性を検証

**実施者:** 開発チーム

**実施タイミング:** 統合テスト完了後

**テスト内容:**

#### 3.4.1 性能テスト
- 予約処理時間（依頼受付から決済リンク送信まで5分以内）
- SMS送信時間（3秒以内）
- 同時並列予約（10件/分）

#### 3.4.2 セキュリティテスト
- データ暗号化の検証（予約処理に関わる全データが暗号化されて保存されること）
- 暗号化データの復号化テスト（暗号化されたデータが正しく復号化できること）
- 暗号化キーの安全な管理（環境変数での管理、漏洩防止）
- API認証（MCPトークン）
- 決済情報の非保持（Stripe委託）

#### 3.4.3 可用性テスト
- システム稼働率の監視
- エラー時の通知機能

**成功基準:**
- 非機能要件（6章）の全項目を満たすこと

---

## 4. テスト環境

### 4.1 環境構成

| 環境 | 用途 | 外部サービス |
|------|------|-------------|
| 開発環境 | 開発者の個別開発・ユニットテスト | モック化 |
| テスト環境 | 統合テスト、受け入れテスト | テストアカウント使用 |
| 本番環境 | 実運用 | 本番アカウント |

### 4.2 外部サービスのテストアカウント

| サービス | テスト方法 |
|---------|----------|
| Bland.ai | 無料トライアル枠を使用 |
| Twilio | テストモード（実際のSMS送信なし） |
| Stripe | テストモード（実際の決済なし） |
| SendGrid | 無料枠を使用 |

### 4.3 テストデータ

**提携店CSV:**
- テスト用提携店データ（各サービス3-5店舗）
- 電話番号は開発チームのテスト用番号

**依頼者電話番号:**
- 開発チームのテスト用携帯電話番号

**予約データ:**
- サンプル予約リクエスト（正常系・異常系）

---

## 5. テスト実施スケジュール

### 5.1 フェーズ別テスト計画

| フェーズ | テストレベル | 実施内容 |
|---------|------------|---------|
| **要件定義** | 受け入れ基準定義 | 各機能要件に受け入れ基準を追加 |
| **設計** | テストケース設計 | ユニットテスト、統合テストのケース設計 |
| **実装** | ユニットテスト | TDDサイクルで実装とテストを並行 |
| **実装（統合）** | 統合テスト | コンポーネント間連携の検証 |
| **テスト** | 受け入れテスト | ビジネス要件の最終検証 |
| **テスト** | 非機能テスト | 性能、セキュリティ、可用性の検証 |
| **リリース前** | 最終確認 | 全テストの再実行、リグレッションテスト |

### 5.2 各フェーズの成果物

| フェーズ | 成果物 |
|---------|--------|
| 要件定義 | 受け入れ基準（要件定義書に追記） |
| 設計 | テスト仕様書、テストケース一覧 |
| 実装 | ユニットテストコード、テスト実行結果 |
| 実装（統合） | 統合テスト実行結果 |
| テスト | 受け入れテスト実行結果、非機能テスト実行結果 |
| リリース前 | テストサマリーレポート |

---

## 6. リスク管理

### 6.1 テストリスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|--------|---------|------|
| 外部API（Bland.ai等）の不安定性 | 高 | 中 | モック化による初期テスト、段階的な実API統合 |
| SMS送信の遅延・失敗 | 高 | 中 | リトライ機能の実装、タイムアウト処理の徹底 |
| 決済処理のエラー | 高 | 低 | Stripeテストモードでの徹底検証、エラーハンドリング強化 |
| 並列処理のデッドロック | 中 | 中 | Celeryタスクの設計レビュー、負荷テスト実施 |
| 電話受付時間外の予約 | 中 | 高 | 受付時間チェックロジックのユニットテスト強化 |
| テストデータ不足 | 低 | 中 | テストデータ生成スクリプトの作成 |

### 6.2 バグ管理方針

**バグの優先度分類:**

| 優先度 | 定義 | 対応 |
|-------|------|------|
| Critical | システムが動作しない、重大な機能不全 | 即座に修正、リリースブロック |
| Major | 主要機能に影響、回避策なし | 優先的に修正 |
| Minor | 軽微な不具合、回避策あり | 次回リリースで修正 |
| Trivial | UIの微調整等 | 必要に応じて修正 |

**バグ追跡:**
- GitHub Issuesでバグを管理
- 各バグに優先度ラベルを付与
- 週次でバグレビュー会議を実施

---

## 付録

### A. テストツール

| 用途 | ツール |
|------|--------|
| ユニットテスト | pytest（Python） |
| モック化 | unittest.mock、pytest-mock |
| カバレッジ測定 | pytest-cov |
| 統合テスト | pytest + 実際の外部API |
| 負荷テスト | Locust（将来実装） |

### B. 参考資料

- 要件定義書 v2.1
- 業務フロー図
- 要件定義_図表

---

**文書終了**
