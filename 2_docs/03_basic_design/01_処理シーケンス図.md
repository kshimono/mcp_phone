# QRV 基本設計 - 処理シーケンス図

**文書バージョン:** 1.0
**作成日:** 2025-01-29
**関連文書:** [要件定義書](../02_requirement/1_definition/01_要件定義書.md) v2.1

---

## 目次

1. [正常系フロー（時間制約の可視化）](#1-正常系フロー時間制約の可視化)
2. [タイムアウト時の処理](#2-タイムアウト時の処理)
3. [キャンセル処理](#3-キャンセル処理)
4. [全店NG時の処理](#4-全店ng時の処理)

---

## 1. 正常系フロー（時間制約の可視化）

```mermaid
sequenceDiagram
    participant 依頼者
    participant AIエージェント
    participant QRVシステム
    participant 提携店
    participant 決済システム

    Note over 依頼者,AIエージェント: 予約情報の収集
    依頼者->>AIエージェント: 予約依頼（チャット）
    AIエージェント->>依頼者: 必要情報を質問
    依頼者->>AIエージェント: 情報提供
    AIエージェント->>QRVシステム: 予約リクエスト作成

    Note over 依頼者,QRVシステム: SMS確認（10分以内）
    QRVシステム->>依頼者: SMS確認リンク送信

    rect rgb(255, 240, 240)
        Note right of 依頼者: タイムリミット: 10分
        依頼者->>QRVシステム: 「進める」ボタン押下
    end

    Note over QRVシステム,提携店: 電話代行（自動）
    QRVシステム->>提携店: 自動音声電話（1周目）
    提携店->>QRVシステム: 予約可能を回答

    Note over 依頼者,決済システム: 決済（10分以内）
    QRVシステム->>依頼者: SMS決済リンク送信
    QRVシステム->>提携店: SMS/Email通知（決済待ち）

    rect rgb(255, 240, 240)
        Note right of 依頼者: タイムリミット: 10分
        依頼者->>決済システム: 決済実行
    end

    決済システム->>QRVシステム: Webhook通知（決済完了）
    QRVシステム->>依頼者: SMS確定通知（キャンセルURL含む）
    QRVシステム->>提携店: SMS/Email確定通知

    Note over 依頼者,提携店: リマインダー（48時間前・2時間前）

    rect rgb(240, 255, 240)
        Note over QRVシステム: 予約日の48時間前
        QRVシステム->>依頼者: SMSリマインダー（第1回、キャンセルURL含む）
        QRVシステム->>提携店: SMSリマインダー（第1回）
    end

    rect rgb(240, 255, 240)
        Note over QRVシステム: 予約日の2時間前
        QRVシステム->>依頼者: SMSリマインダー（第2回）
        QRVシステム->>提携店: SMSリマインダー（第2回）
    end
```

---

## 2. タイムアウト時の処理

```mermaid
sequenceDiagram
    participant 依頼者
    participant QRVシステム
    participant 提携店

    Note over 依頼者,QRVシステム: パターン1: SMS確認タイムアウト
    QRVシステム->>依頼者: SMS確認リンク送信

    rect rgb(255, 220, 220)
        Note right of 依頼者: 10分経過（未応答）
        QRVシステム->>QRVシステム: 予約リクエスト自動削除
    end

    Note over 依頼者: 再度AIエージェントから<br/>やり直しが必要

    Note over 依頼者,提携店: パターン2: 決済タイムアウト
    QRVシステム->>依頼者: SMS決済リンク送信
    QRVシステム->>提携店: SMS通知（決済待ち）

    rect rgb(255, 220, 220)
        Note right of 依頼者: 10分経過（未決済）
        QRVシステム->>QRVシステム: 予約自動解放
        QRVシステム->>依頼者: SMSリリース通知
        QRVシステム->>提携店: SMSキャンセル通知
    end
```

---

## 3. キャンセル処理

```mermaid
sequenceDiagram
    participant 依頼者
    participant QRVシステム
    participant Stripe
    participant 提携店

    Note over 依頼者,提携店: 48時間前までのキャンセル
    依頼者->>QRVシステム: キャンセルURLをクリック
    QRVシステム->>依頼者: キャンセル確認画面表示

    依頼者->>QRVシステム: 「キャンセルする」ボタン押下
    QRVシステム->>Stripe: 返金処理実行
    Stripe->>QRVシステム: 返金完了通知

    QRVシステム->>依頼者: SMSキャンセル完了通知
    QRVシステム->>提携店: SMS/Emailキャンセル通知
```

---

## 4. 全店NG時の処理

```mermaid
sequenceDiagram
    participant 依頼者
    participant QRVシステム
    participant 提携店A
    participant 提携店B
    participant 提携店N

    QRVシステム->>依頼者: SMS確認完了後

    Note over QRVシステム,提携店N: 1周目: 全提携店に順次電話
    QRVシステム->>提携店A: 自動音声電話
    提携店A->>QRVシステム: NG（時間帯が埋まっている）
    QRVシステム->>提携店B: 自動音声電話
    提携店B->>QRVシステム: NG（応答なし）
    QRVシステム->>提携店N: 自動音声電話
    提携店N->>QRVシステム: NG（エリア対応不可）

    Note over QRVシステム,提携店B: 2周目: 応答なし・話中の店のみ再電話
    QRVシステム->>QRVシステム: 1周目で応答なし・話中の店舗を抽出
    QRVシステム->>提携店B: 自動音声電話（2回目）
    提携店B->>QRVシステム: NG（応答なし）

    Note over QRVシステム: 提携店A、Nは再試行対象外<br/>（時間帯埋まり、エリア不可）

    rect rgb(255, 220, 220)
        Note over QRVシステム: 2周しても全店NG
        QRVシステム->>QRVシステム: 代替案を抽出
        QRVシステム->>依頼者: SMS（代替可能な時間帯を提示）
    end
```

---

## 利用目的と設計指針

### タイミング図の利用シーン
- **タスクキュー（Celery）のタスク設計**
- **タイムアウト監視処理の設計**
- **依頼者・提携店への通知タイミングの確認**

### 実装時の注意点
1. **タイムアウト管理**
   - SMS確認: 10分以内に未応答 → 予約リクエスト削除
   - 決済: 10分以内に未決済 → 予約解放、提携店に通知

2. **リマインダー送信タイミング**
   - 第1回: 予約日の48時間前
   - 第2回: 予約日の2時間前

3. **全店NG時の再試行ロジック**
   - 1周目: 全提携店に順次電話
   - 2周目: 応答なし・話中の店舗のみ再試行
   - 明示的なNG（時間帯埋まり、エリア不可）は再試行対象外

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2025-01-29 | 要件定義の図表集から基本設計に移動 | - |

---

**文書終了**
