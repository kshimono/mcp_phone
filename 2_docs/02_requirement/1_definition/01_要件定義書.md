# QRV (Qualfia Reservation) 要件定義書

**文書バージョン:** 2.2
**作成日:** 2025-01-26
**最終更新日:** 2025-01-29
**プロジェクトコード:** QRV
**プロジェクト名（英語）:** Qualfia Reservation
**プロジェクト名（日本語）:** 未定
**関連文書:**
- [業務フロー図](02_業務フロー図.md)
- [機能要件定義書](03_機能要件定義書.md)
- [非機能要件定義書](04_非機能要件定義書.md)
- [運用要件定義書](05_運用要件定義書.md)
- [処理シーケンス図](../../03_basic_design/01_処理シーケンス図.md) ※基本設計
- [データモデル](../../03_basic_design/02_データモデル.md) ※基本設計

---

## 目次

1. [概要](#1-概要)
2. [プロジェクトの目的と背景](#2-プロジェクトの目的と背景)
3. [システム概要](#3-システム概要)
4. [機能要件](#4-機能要件)
5. [非機能要件](#5-非機能要件)
6. [受け入れ基準](#6-受け入れ基準)
7. [データモデル](#7-データモデル)
8. [外部連携](#8-外部連携)
9. [制約事項](#9-制約事項)
10. [今後の拡張予定](#10-今後の拡張予定)
11. [用語集](#11-用語集)

**参考:**
- 業務フロー図: [02_業務フロー図.md](02_業務フロー図.md)
- 機能要件定義書: [03_機能要件定義書.md](03_機能要件定義書.md)
- 非機能要件定義書: [04_非機能要件定義書.md](04_非機能要件定義書.md)
- 運用要件定義書: [05_運用要件定義書.md](05_運用要件定義書.md)
- 処理シーケンス図: [01_処理シーケンス図.md](../../03_basic_design/01_処理シーケンス図.md) ※基本設計フェーズ
- データモデル: [02_データモデル.md](../../03_basic_design/02_データモデル.md) ※基本設計フェーズ

---

## 1. 概要

### 1.1 プロジェクト概要

QRV（Qualfia Reservation）は、AIエージェントを活用した電話予約代行・決済代行システムです。様々な業種に対応可能な汎用的な設計とし、サンプル実装として時間制サービス（出張マッサージ）とサイズオーダー型サービス（花の配送）を例示します。将来的にはケータリング、会場予約など多様なサービスへ展開可能です。

### 1.2 主要機能

- **AIチャット予約受付**: Claude Desktop、ChatGPT等のMCPクライアントから予約依頼を受付
- **予約状況問い合わせ**: MCP経由で予約IDによる状況確認が可能
- **自動音声電話代行**: 提携店に自動音声で電話し、予約を確定
- **決済代行**: Stripeを利用したオンライン決済
- **キャンセル処理**: 予約日時の48時間前までURL経由でキャンセル可能
- **SMS/Email通知**: 依頼者・提携店への自動通知
- **並列処理**: 複数予約の同時処理に対応

### 1.3 提供主体

- **運営会社**: 株式会社Qualfia
- **サービス提供者**: 提携事業者（サンプル: マッサージ店、花屋等。依頼者には店舗名を非公開）

### 1.4 対象ユーザー

- **依頼者**: 個人（サービスを利用する一般消費者）
- **提携店**: サービス提供事業者（サンプル: マッサージ店、花屋等）

---

## 2. プロジェクトの目的と背景

### 2.1 目的

1. **電話予約の自動化**: 人手を介さず、AIが自動で電話予約を完結
2. **顧客体験の向上**: チャットベースの簡単な予約フロー
3. **提携店の負荷軽減**: 標準化された予約情報の伝達
4. **スケーラビリティ**: 複数サービスへの展開可能な設計

### 2.2 背景

- 多様な業種における電話予約の煩雑さ（依頼者・提携店双方の負担）
- AI音声技術の成熟（Bland.ai、OpenAI Realtime API等）
- MCP（Model Context Protocol）による汎用的なインターフェース
- 事前に料金を定義できるサービス領域における自動化ニーズ

---

## 3. システム概要

### 3.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│  依頼者                                                      │
│  └─ Claude Desktop / ChatGPT (MCP Client)                   │
└────────────────┬────────────────────────────────────────────┘
                 │ MCP Protocol
                 ▼
┌─────────────────────────────────────────────────────────────┐
│  QRV System                                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ MCP Server (Python)                                  │   │
│  │  - create_reservation                                │   │
│  │  - check_reservation_status                          │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ API Server (FastAPI)                                 │   │
│  │  - 予約管理                                           │   │
│  │  - 決済管理                                           │   │
│  │  - 通知管理                                           │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Task Queue (Celery + Redis)                          │   │
│  │  - 並列予約処理                                        │   │
│  │  - 電話発信タスク                                      │   │
│  │  - 通知送信タスク                                      │   │
│  └──────────────────────────────────────────────────────┘   │
└────┬────────────┬────────────┬────────────┬────────────────┘
     │            │            │            │
     ▼            ▼            ▼            ▼
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐
│ Bland.ai│ │ Twilio  │ │ Stripe  │ │ PostgreSQL  │
│ (電話)  │ │ (SMS)   │ │ (決済)  │ │ (DB)        │
└─────────┘ └─────────┘ └─────────┘ └─────────────┘
     │            │
     ▼            ▼
┌─────────────────────┐  ┌──────────────┐
│ 提携店              │  │ SendGrid     │
│ (CSV管理)           │  │ (Email)      │
└─────────────────────┘  └──────────────┘
```

### 3.2 処理フロー概要

1. **予約依頼**: 依頼者がMCPクライアントでAIとチャット
2. **SMS確認**: 依頼者の電話番号にSMS送信、10分以内に確認
3. **電話代行**: 提携店に直列で自動音声電話（最大2周、2周目は応答なし・話中の店のみ、1店舗でも成功したら終了）
4. **決済**: 予約成功後、依頼者にSMSで決済リンク送信（10分以内）
5. **確定**: 決済完了で予約確定、依頼者・提携店に通知
6. **リマインダー**: 予約日の48時間前と2時間前にSMS送信
7. **キャンセル**: 予約日時の48時間前まで、キャンセルURL経由で可能

---

## 4. 機能要件

機能要件の詳細は以下の専用ドキュメントを参照してください。

### 📄 [機能要件定義書](03_機能要件定義書.md)

以下の機能要件を網羅的に定義しています：

1. **予約受付機能**
   - チャット予約受付
   - 予約状況問い合わせ
   - SMS確認機能

2. **電話代行機能**
   - 提携店選定
   - 自動音声電話
   - リトライロジック

3. **決済機能**
   - Stripe決済フロー
   - 決済ステータス管理
   - 決済失敗時の処理

4. **通知機能**
   - SMS通知
   - Email通知
   - リマインダー通知

5. **キャンセル機能**
   - キャンセル可能期間
   - 返金処理
   - ペナルティ計算

6. **管理機能**
   - 予約管理
   - 提携店管理
   - レポート機能

7. **並列処理**
   - タスクキュー管理
   - 並列予約処理

8. **サービスタイプ管理機能**
   - サービスタイプの動的追加
   - 料金計算の実装
   - データ項目のカスタマイズ

詳細は [03_機能要件定義書.md](03_機能要件定義書.md) を参照してください。

---

## 5. 非機能要件

### 5.1 パフォーマンス

#### 5.1.1 応答時間

- **MCP API応答時間**: 3秒以内（90パーセンタイル）
- **SMS送信**: 10秒以内
- **電話発信開始**: 1分以内（SMS確認完了後）
- **決済リンク送信**: 10秒以内

#### 5.1.2 同時処理

- **同時予約処理**: 最大50件（Celeryワーカー数で調整）
- **電話発信並列度**: 最大10件（Bland.aiの同時通話制限に依存）

---

### 5.2 可用性

#### 5.2.1 稼働率

- **目標稼働率**: 99.5%（月間ダウンタイム3.6時間まで許容）
- **サービス停止通知**: 24時間前に依頼者・提携店にEmail通知

#### 5.2.2 障害対応

- **自動リトライ**: SMS送信、電話発信、決済リンク送信は最大3回リトライ
- **手動対応フロー**: 全リトライ失敗時は管理者にSlack通知

---

### 5.3 拡張性

#### 5.3.1 サービスタイプ追加

- **設定ファイル追加のみ**: 新サービス追加時はJSON/CSV追加のみでコード変更不要
- **料金計算プログラム追加**: `src/pricing/pricing_{service_code}.py` を追加

#### 5.3.2 ユーザー数

- **初期想定**: 月間1000件の予約
- **スケール目標**: 月間10000件まで対応可能（インフラ拡張で実現）

---

### 5.4 セキュリティ

#### 5.4.1 通信

- **HTTPS通信**: 全API通信はHTTPS必須
- **API認証**: MCPサーバー ⇄ FastAPI間はJWTトークンで認証

#### 5.4.2 データ保護

- **個人情報暗号化**: 電話番号、住所、メールアドレスはAES-256で暗号化
- **決済情報**: Stripeのトークン方式を使用、QRVサーバーではカード番号を保存しない

#### 5.4.3 アクセス制御

- **管理画面**: IP制限 + パスワード認証
- **提携店情報**: CSV管理、GitHubプライベートリポジトリで管理

---

### 5.5 運用性

#### 5.5.1 ログ

- **ログレベル**: INFO（本番）、DEBUG（開発）
- **ログ保存**: CloudWatch Logs（30日間保存）
- **エラー通知**: ERRORレベルのログはSlack通知

#### 5.5.2 バックアップ

- **データベース**: 毎日1回自動バックアップ（30日間保存）
- **設定ファイル**: GitHubでバージョン管理

#### 5.5.3 モニタリング

- **死活監視**: Pingdom（5分間隔）
- **メトリクス**: CloudWatch Metrics（CPU、メモリ、Celeryキュー長）
- **アラート**: CPU 80%超過、キュー長100超過でSlack通知

---

## 6. 受け入れ基準

### 6.1 機能テスト

#### 6.1.1 予約受付

- [ ] MCPクライアントから予約リクエスト作成可能
- [ ] サービスタイプごとの必須項目が正しく収集される
- [ ] 予約ID生成後、10分以内にSMS送信される

#### 6.1.2 電話代行

- [ ] 提携店リストから対応エリア内の店舗のみ抽出される
- [ ] スコア降順で電話発信される
- [ ] 1店舗でも仮予約成功したら処理終了
- [ ] 全店NGの場合、2周目まで試行される

#### 6.1.3 決済

- [ ] 仮予約成功後、10分以内に決済リンクがSMS送信される
- [ ] 決済完了で予約ステータスが `confirmed` に更新される
- [ ] 決済失敗時、3回まで再試行可能

#### 6.1.4 通知

- [ ] 予約確定後、依頼者にSMS + Email送信される
- [ ] 予約確定後、提携店にEmail送信される
- [ ] リマインダーが予約日の48時間前と2時間前に送信される

#### 6.1.5 キャンセル

- [ ] 予約日時の48時間前まで、キャンセルURL経由でキャンセル可能
- [ ] キャンセル成功後、全額返金される
- [ ] 48時間以内のキャンセルは不可（エラーメッセージ表示）

---

### 6.2 非機能テスト

#### 6.2.1 負荷テスト

- [ ] 同時50件の予約リクエストを処理可能
- [ ] MCP API応答時間が3秒以内（90パーセンタイル）

#### 6.2.2 セキュリティテスト

- [ ] HTTPS通信が必須化されている
- [ ] 個人情報が暗号化されている（電話番号、住所、メールアドレス）
- [ ] 管理画面がIP制限 + パスワード認証で保護されている

---

### 6.3 サンプル実装

以下の2つのサービスタイプが実装され、正常動作すること：

#### 6.3.1 サービス00001: 出張マッサージ

- [ ] 予約受付時に「派遣先住所」「希望日時」「希望時間」を収集
- [ ] 料金計算: 基本料金 + (時間単価 × 希望時間) で正しく計算
- [ ] 提携店リストから対応エリア内のマッサージ店のみ抽出

#### 6.3.2 サービス00002: 花の配送

- [ ] 予約受付時に「配送先住所」「配送日時」「サイズ」「スタンドメッセージ」を収集
- [ ] 料金計算: サイズごとの料金表で正しく計算
- [ ] 提携店リストから対応エリア内の花屋のみ抽出

---

## 7. データモデル

### 7.1 データ項目定義

#### 7.1.1 予約データ（reservations）

| 項目名 | データ型 | 必須 | 説明 | 例 |
|-------|---------|------|------|---|
| `reservation_id` | STRING | ✅ | 予約ID（一意） | QRV-A3F9D2 |
| `service_type` | STRING | ✅ | サービスタイプコード | 00001 |
| `user_phone` | STRING | ✅ | 依頼者電話番号（暗号化） | 090-1234-5678 |
| `user_email` | STRING | - | 依頼者メールアドレス（暗号化） | user@example.com |
| `requested_datetime` | DATETIME | ✅ | 予約希望日時 | 2025-02-15 14:00 |
| `status` | ENUM | ✅ | 予約ステータス | pending, calling, payment_waiting, confirmed, completed, failed, cancelled |
| `total_price` | INTEGER | ✅ | 合計料金（円） | 15000 |
| `service_details` | JSONB | ✅ | サービス固有の情報 | `{"delivery_address": "..."}` |
| `created_at` | TIMESTAMP | ✅ | 作成日時 | 2025-01-20 10:00:00 |
| `updated_at` | TIMESTAMP | ✅ | 更新日時 | 2025-01-20 10:05:00 |

#### 7.1.2 提携店データ（shops_{service_type}.csv）

| 項目名 | データ型 | 必須 | 説明 | 例 |
|-------|---------|------|------|---|
| `shop_id` | STRING | ✅ | 店舗ID | SHOP-001 |
| `shop_name` | STRING | ✅ | 店舗名 | 〇〇マッサージ店 |
| `phone_number` | STRING | ✅ | 電話番号 | 03-1234-5678 |
| `supported_areas` | STRING | ✅ | 対応エリア（カンマ区切り） | 渋谷区,新宿区 |
| `phone_reception_start` | TIME | ✅ | 電話受付開始時刻 | 09:00 |
| `phone_reception_end` | TIME | ✅ | 電話受付終了時刻 | 18:00 |
| `score` | INTEGER | ✅ | 優先度スコア | 95 |
| `email` | STRING | ✅ | Email通知先 | shop@example.com |

#### 7.1.3 サービス定義データ（service_definitions/{service_type}.json）

```json
{
  "service_code": "00001",
  "service_name": "出張マッサージ",
  "description": "指定場所への出張マッサージサービス",
  "required_fields": [
    "delivery_address",
    "preferred_datetime",
    "preferred_duration"
  ],
  "optional_fields": [
    "special_requests"
  ],
  "pricing_module": "src/pricing/pricing_00001.py"
}
```

### 7.2 データフロー概要

データモデルの詳細と関連図は、基本設計フェーズで作成します。
参照: [02_データモデル.md](../../03_basic_design/02_データモデル.md)

---

## 8. 外部連携

### 8.1 Bland.ai（音声電話）

- **用途**: 提携店への自動音声電話
- **API**: Bland.ai REST API
- **認証**: APIキー認証
- **制約**: 同時通話数10件まで

### 8.2 Twilio（SMS送信）

- **用途**: 依頼者へのSMS通知（確認リンク、決済リンク、リマインダー）
- **API**: Twilio REST API
- **認証**: Account SID + Auth Token
- **制約**: 送信レート制限あり（詳細はTwilioドキュメント参照）

### 8.3 Stripe（決済）

- **用途**: 依頼者のオンライン決済、返金処理
- **API**: Stripe REST API
- **認証**: APIキー認証
- **制約**: トークン方式、QRVサーバーではカード番号を保存しない

### 8.4 SendGrid（Email送信）

- **用途**: 依頼者・提携店へのEmail通知
- **API**: SendGrid REST API
- **認証**: APIキー認証
- **制約**: 送信レート制限あり（詳細はSendGridドキュメント参照）

---

## 9. 制約事項

### 9.1 技術的制約

- **MCP対応クライアント**: Claude Desktop、ChatGPT等、MCPプロトコル対応クライアントのみ
- **電話発信地域**: 日本国内のみ（Bland.aiの対応地域に依存）
- **決済通貨**: 日本円（JPY）のみ

### 9.2 運用的制約

- **提携店管理**: CSVファイルで管理（初期フェーズ）。将来的には管理画面で編集可能にする
- **サービス追加**: JSON/CSV追加 + 料金計算プログラム追加が必要
- **手動対応が必要なケース**:
  - 全リトライ失敗時の手動対応
  - 提携店からの電話回答が曖昧な場合の判断

### 9.3 法的制約

- **個人情報保護法**: 依頼者・提携店の個人情報は暗号化必須
- **電子商取引法**: キャンセルポリシーを明示
- **消費者契約法**: 不当な契約条項を排除

---

## 10. 今後の拡張予定

### 10.1 管理画面の追加

- **対象ユーザー**: Qualfia運営担当者
- **機能**:
  - 予約一覧表示・検索
  - 提携店管理（CSV編集 → DB管理に移行）
  - サービス定義管理（JSON編集 → DB管理に移行）
  - レポート表示（売上、予約数、成功率）

### 10.2 音声電話エンジンの切り替え

- **現状**: Bland.ai
- **将来**: OpenAI Realtime API等の選択肢を評価

### 10.3 新サービスタイプの追加

- **候補**:
  - ケータリング予約
  - 会場予約
  - 家事代行予約
  - ペットシッター予約

### 10.4 多言語対応

- **現状**: 日本語のみ
- **将来**: 英語、中国語等の多言語対応

---

## 11. 用語集

| 用語 | 説明 |
|------|------|
| **依頼者** | サービスを利用する一般消費者 |
| **提携店** | サービス提供事業者（マッサージ店、花屋等） |
| **予約ID** | 予約を一意に識別するID（例: QRV-A3F9D2） |
| **サービスタイプ** | サービスの種類（例: 00001 = 出張マッサージ） |
| **MCP** | Model Context Protocol（AIエージェント連携プロトコル） |
| **仮予約** | 提携店が電話で「受けられる」と回答した状態 |
| **予約確定** | 依頼者が決済完了した状態 |
| **SMS確認** | 依頼者が電話番号にSMSを受信し、「進める」ボタンを押す確認 |
| **決済リンク** | 依頼者がオンライン決済を行うためのStripe URL |
| **キャンセルURL** | 依頼者が予約をキャンセルするためのURL |
| **タスクキュー** | Celery + Redisによる並列処理基盤 |
| **リトライロジック** | SMS送信、電話発信、決済リンク送信の再試行処理 |

---

**文書終了**
