# QRV 非機能要件定義書

**文書バージョン:** 1.0
**作成日:** 2025-01-29
**最終更新日:** 2025-01-29
**プロジェクトコード:** QRV
**プロジェクト名（英語）:** Qualfia Reservation
**プロジェクト名（日本語）:** 未定

**関連文書:**
- [要件定義書](01_要件定義書.md)
- [機能要件定義書](03_機能要件定義書.md)
- [業務フロー図](02_業務フロー図.md)

---

## 目次

1. [概要](#1-概要)
2. [パフォーマンス要件](#2-パフォーマンス要件)
3. [可用性要件](#3-可用性要件)
4. [拡張性要件](#4-拡張性要件)
5. [セキュリティ要件](#5-セキュリティ要件)
6. [運用性要件](#6-運用性要件)
7. [保守性要件](#7-保守性要件)
8. [互換性要件](#8-互換性要件)

---

## 1. 概要

### 1.1 文書の目的

本文書は、QRV（Qualfia Reservation）システムの非機能要件を定義します。非機能要件とは、システムが「どのように動作するか」を規定する要件であり、パフォーマンス、可用性、セキュリティ、運用性などが含まれます。

### 1.2 対象読者

- システム開発者
- インフラエンジニア
- プロジェクトマネージャー
- 品質保証担当者

### 1.3 非機能要件の重要性

非機能要件は、システムの品質特性を定義し、以下の観点で重要です：

- **ユーザー体験**: 応答時間、可用性がサービス満足度に直結
- **運用コスト**: 障害対応、保守作業の効率化
- **セキュリティ**: 個人情報保護、決済情報の安全性
- **拡張性**: 将来的なサービス追加、ユーザー数増加への対応

---

## 2. パフォーマンス要件

### 2.1 応答時間要件

#### 2.1.1 MCP API応答時間

| 項目 | 目標値 | 測定方法 |
|------|--------|----------|
| **平均応答時間** | 1.5秒以内 | リクエスト受信から応答送信まで |
| **90パーセンタイル** | 3秒以内 | 全リクエストの90%が3秒以内に完了 |
| **99パーセンタイル** | 5秒以内 | 全リクエストの99%が5秒以内に完了 |
| **タイムアウト** | 10秒 | 10秒を超えたらエラー返却 |

**測定対象API:**
- `create_reservation`: 予約リクエスト作成
- `check_reservation_status`: 予約状況問い合わせ

**備考:**
- ネットワーク遅延は含まない（MCPサーバー内部の処理時間のみ）
- 外部API（Twilio、Stripe等）の呼び出しは非同期処理のため含まない

---

#### 2.1.2 SMS送信時間

| 項目 | 目標値 | 測定方法 |
|------|--------|----------|
| **SMS送信開始** | 予約リクエスト作成後10秒以内 | Twilioへのリクエスト送信まで |
| **SMS到達時間** | 送信開始後30秒以内 | 依頼者のスマートフォンへの到達 |

**リトライポリシー:**
- 送信失敗時は最大3回リトライ
- リトライ間隔: 5秒、10秒、15秒（指数バックオフ）

---

#### 2.1.3 電話発信開始時間

| 項目 | 目標値 | 測定方法 |
|------|--------|----------|
| **電話発信開始** | SMS確認完了後1分以内 | Celeryタスク開始から最初の電話発信まで |
| **電話間隔** | 30秒以内 | 1店舗への電話終了から次の店舗への発信まで |

**備考:**
- 提携店選定処理の時間を含む
- Bland.ai APIの応答時間に依存

---

#### 2.1.4 決済リンク送信時間

| 項目 | 目標値 | 測定方法 |
|------|--------|----------|
| **決済リンク生成** | 仮予約成功後5秒以内 | Stripe API呼び出しから応答まで |
| **SMS送信開始** | 決済リンク生成後5秒以内 | Twilioへのリクエスト送信まで |
| **合計時間** | 仮予約成功後10秒以内 | 依頼者へのSMS送信完了まで |

---

### 2.2 スループット要件

#### 2.2.1 同時予約処理

| 項目 | 目標値 | 備考 |
|------|--------|------|
| **同時予約リクエスト** | 最大50件 | Celeryワーカー数で調整 |
| **Celeryワーカー数** | 10プロセス | 1プロセスあたり5スレッド |
| **Redisキュー長** | 最大100件 | キュー長超過時は新規予約を一時的に拒否 |

**スケーリング方針:**
- 初期フェーズ: 単一サーバー構成（月間1000件程度）
- 成長フェーズ: Celeryワーカーをスケールアウト（月間10000件対応）

---

#### 2.2.2 電話発信並列度

| 項目 | 目標値 | 備考 |
|------|--------|------|
| **同時通話数** | 最大10件 | Bland.aiの制限に依存 |
| **通話待機キュー** | 最大30件 | 電話発信タスクのキュー長 |

**制約事項:**
- Bland.aiの同時通話制限: 10件（プランに依存）
- 制限超過時は待機キューに入れて順次処理

---

### 2.3 リソース要件

#### 2.3.1 サーバーリソース

| 項目 | 推奨値 | 最小値 |
|------|--------|--------|
| **CPU** | 4コア | 2コア |
| **メモリ** | 8GB | 4GB |
| **ストレージ** | 100GB SSD | 50GB SSD |
| **ネットワーク帯域** | 1Gbps | 100Mbps |

**備考:**
- AWS EC2想定: t3.large以上推奨
- データベースは別サーバー（RDS使用）

---

#### 2.3.2 データベースリソース

| 項目 | 推奨値 | 最小値 |
|------|--------|--------|
| **CPU** | 2コア | 1コア |
| **メモリ** | 4GB | 2GB |
| **ストレージ** | 100GB SSD | 50GB SSD |
| **IOPS** | 3000 | 1000 |

**備考:**
- AWS RDS PostgreSQL想定: db.t3.medium以上推奨
- 自動バックアップ有効化必須

---

## 3. 可用性要件

### 3.1 稼働率要件

#### 3.1.1 目標稼働率

| 項目 | 目標値 | 許容ダウンタイム（月間） |
|------|--------|------------------------|
| **サービス稼働率** | 99.5% | 3.6時間 |
| **データベース稼働率** | 99.9% | 43分 |

**測定方法:**
- 稼働率 = (稼働時間 / 総時間) × 100
- Pingdomによる外形監視（5分間隔）

---

#### 3.1.2 計画停止

| 項目 | 詳細 |
|------|------|
| **通知タイミング** | 24時間前にEmail通知 |
| **通知対象** | 依頼者（進行中の予約がある場合のみ）、提携店 |
| **実施時間帯** | 深夜2:00〜4:00（日本時間） |
| **頻度** | 月1回まで |

---

### 3.2 障害対応要件

#### 3.2.1 自動リトライ

| 対象処理 | リトライ回数 | リトライ間隔 | タイムアウト |
|---------|-------------|-------------|-------------|
| **SMS送信** | 3回 | 5秒、10秒、15秒 | 各30秒 |
| **電話発信** | 2周（店舗リスト全体） | - | 各通話3分 |
| **決済リンク送信** | 3回 | 5秒、10秒、15秒 | 各30秒 |
| **Stripe API** | 3回 | 2秒、4秒、8秒 | 各10秒 |

---

#### 3.2.2 手動対応フロー

**全リトライ失敗時:**
1. 管理者にSlack通知（ERRORレベルログ）
2. 管理者が手動で状況確認
3. 必要に応じて依頼者に電話連絡

**通知内容:**
- 予約ID
- 失敗したステップ（SMS送信、電話発信、決済リンク送信）
- エラーメッセージ
- 依頼者連絡先

---

#### 3.2.3 障害復旧時間目標（RTO/RPO）

| 項目 | 目標値 | 備考 |
|------|--------|------|
| **RTO（復旧時間目標）** | 2時間 | 障害発生から復旧まで |
| **RPO（復旧ポイント目標）** | 1時間 | 障害時のデータ損失許容範囲 |

**復旧手順:**
1. 障害検知（Pingdom、CloudWatch Alarms）
2. 原因特定（ログ確認、メトリクス分析）
3. 復旧作業（サーバー再起動、コード修正、ロールバック等）
4. 動作確認（疎通テスト、機能テスト）
5. 監視強化（24時間）

---

### 3.3 バックアップ要件

#### 3.3.1 データベースバックアップ

| 項目 | 詳細 |
|------|------|
| **バックアップ頻度** | 毎日1回（深夜3:00） |
| **保存期間** | 30日間 |
| **バックアップ方式** | RDS自動バックアップ（スナップショット） |
| **復旧テスト** | 月1回 |

---

#### 3.3.2 設定ファイルバックアップ

| 項目 | 詳細 |
|------|------|
| **バックアップ方式** | GitHubプライベートリポジトリ |
| **対象ファイル** | 提携店CSV、サービス定義JSON、環境変数設定 |
| **バージョン管理** | Git履歴で管理 |
| **復旧手順** | Gitからチェックアウトして再デプロイ |

---

## 4. 拡張性要件

### 4.1 サービスタイプ拡張

#### 4.1.1 新サービス追加手順

新しいサービスタイプを追加する際は、以下のファイルを追加するのみでコード変更不要：

1. **サービス定義JSON**: `service_definitions/{service_code}.json`
2. **提携店CSV**: `data/shops_{service_code}.csv`
3. **料金計算プログラム**: `src/pricing/pricing_{service_code}.py`

**所要時間目標:**
- 設定ファイル作成: 1時間
- 料金計算プログラム実装: 2〜4時間
- テスト: 2時間
- 合計: **1営業日以内**

---

#### 4.1.2 料金計算プログラムインターフェース

全ての料金計算プログラムは以下のインターフェースを実装：

```python
def calculate_price(reservation_data: dict) -> int:
    """
    予約データから料金を計算する

    Args:
        reservation_data: 予約データ（service_detailsを含む）

    Returns:
        int: 料金（円）

    Raises:
        ValueError: 必須項目が不足している場合
        CalculationError: 料金計算に失敗した場合
    """
    pass
```

**実装例:**
- `pricing_00001.py`: 時間制料金（出張マッサージ）
- `pricing_00002.py`: サイズ別料金（花の配送）

---

### 4.2 ユーザー数拡張

#### 4.2.1 スケーリング戦略

| フェーズ | 月間予約数 | サーバー構成 | 想定コスト（月額） |
|---------|-----------|-------------|-------------------|
| **初期** | 〜1,000件 | 単一サーバー | $200 |
| **成長** | 1,000〜10,000件 | Celeryワーカースケールアウト | $500 |
| **拡大** | 10,000件〜 | ロードバランサー + 複数サーバー | $1,500〜 |

---

#### 4.2.2 ボトルネック対策

**想定ボトルネック:**
1. **Celeryキュー長の増加** → ワーカー数を増やす（horizontal scaling）
2. **データベース負荷** → RDSのスペックアップ（vertical scaling）、リードレプリカ追加
3. **外部API制限** → Bland.aiプランアップグレード、SMS送信量の最適化

---

## 5. セキュリティ要件

### 5.1 通信セキュリティ

#### 5.1.1 HTTPS通信

| 項目 | 要件 |
|------|------|
| **全API通信** | HTTPS必須（TLS 1.2以上） |
| **証明書** | Let's Encrypt（自動更新） |
| **HTTP接続** | HTTPSへリダイレクト |

---

#### 5.1.2 API認証

| 通信経路 | 認証方式 | 詳細 |
|---------|---------|------|
| **MCPサーバー ⇄ FastAPI** | JWT認証 | 有効期限24時間、署名検証必須 |
| **外部API（Twilio、Stripe等）** | APIキー認証 | 環境変数で管理、コードに埋め込み禁止 |

---

### 5.2 データ保護

#### 5.2.1 個人情報暗号化

| データ項目 | 暗号化方式 | 鍵管理 |
|-----------|-----------|--------|
| **電話番号** | AES-256-GCM | AWS KMS |
| **メールアドレス** | AES-256-GCM | AWS KMS |
| **住所** | AES-256-GCM | AWS KMS |

**暗号化タイミング:**
- DB保存時に暗号化
- DB読み込み時に復号化
- ログ出力時はマスキング（例: `090-****-5678`）

---

#### 5.2.2 決済情報

| 項目 | 要件 |
|------|------|
| **カード番号** | QRVサーバーでは保存しない（Stripeトークン方式） |
| **決済トークン** | Stripeが管理、QRVは参照のみ |
| **PCI DSS準拠** | Stripe利用により不要（Stripeが準拠） |

---

### 5.3 アクセス制御

#### 5.3.1 管理画面（将来実装）

| 項目 | 要件 |
|------|------|
| **認証** | パスワード認証（bcryptハッシュ） |
| **IP制限** | 社内IPのみ許可（ホワイトリスト方式） |
| **セッション管理** | 30分無操作でタイムアウト |
| **二要素認証** | 将来的に導入検討 |

---

#### 5.3.2 提携店情報管理

| 項目 | 要件 |
|------|------|
| **管理方法** | CSVファイル（GitHubプライベートリポジトリ） |
| **アクセス権限** | 開発チームのみ |
| **変更履歴** | Git履歴で管理 |

---

### 5.4 セキュリティ監査

#### 5.4.1 ログ監査

| 項目 | 詳細 |
|------|------|
| **監査対象** | 予約作成、決済処理、キャンセル処理、管理画面アクセス |
| **ログ項目** | タイムスタンプ、ユーザーID、アクション、IPアドレス |
| **ログ保存期間** | 1年間 |

---

#### 5.4.2 脆弱性対策

| 項目 | 対策 |
|------|------|
| **依存ライブラリ** | 月1回の脆弱性スキャン（Dependabot） |
| **SQLインジェクション** | ORMの使用（SQLAlchemy）、生SQLの禁止 |
| **XSS** | 入力値のサニタイズ、出力時のエスケープ |
| **CSRF** | トークン検証（FastAPI標準機能） |

---

## 6. 運用性要件

### 6.1 ログ管理

#### 6.1.1 ログレベル

| 環境 | ログレベル | 出力先 |
|------|-----------|--------|
| **本番** | INFO | CloudWatch Logs |
| **ステージング** | DEBUG | CloudWatch Logs |
| **開発** | DEBUG | 標準出力 |

---

#### 6.1.2 ログ項目

全てのログには以下の項目を含める：

| 項目 | 説明 | 例 |
|------|------|---|
| **timestamp** | タイムスタンプ（ISO 8601形式） | 2025-01-29T10:30:45.123Z |
| **level** | ログレベル | INFO, ERROR, WARNING, DEBUG |
| **service** | サービス名 | mcp-server, api-server, celery-worker |
| **reservation_id** | 予約ID（存在する場合） | QRV-A3F9D2 |
| **message** | ログメッセージ | SMS sent successfully |
| **context** | コンテキスト情報（JSON） | {"user_phone": "090-****-5678"} |

---

#### 6.1.3 ログ保存期間

| ログタイプ | 保存期間 | 備考 |
|-----------|---------|------|
| **アプリケーションログ** | 30日間 | CloudWatch Logs |
| **エラーログ** | 90日間 | CloudWatch Logs |
| **監査ログ** | 1年間 | S3にアーカイブ |

---

### 6.2 モニタリング

#### 6.2.1 死活監視

| 項目 | 詳細 |
|------|------|
| **監視ツール** | Pingdom |
| **監視間隔** | 5分 |
| **監視対象** | MCP APIヘルスチェックエンドポイント（`/health`） |
| **アラート通知先** | Slack（#qrv-alerts） |

---

#### 6.2.2 メトリクス監視

| メトリクス | 監視間隔 | アラート閾値 | 通知先 |
|-----------|---------|-------------|--------|
| **CPU使用率** | 5分 | 80%超過（5分継続） | Slack |
| **メモリ使用率** | 5分 | 80%超過（5分継続） | Slack |
| **Celeryキュー長** | 1分 | 100件超過 | Slack |
| **エラー率** | 5分 | 5%超過 | Slack |
| **API応答時間** | 5分 | 90パーセンタイル5秒超過 | Slack |

**監視ツール:**
- CloudWatch Metrics
- CloudWatch Alarms

---

#### 6.2.3 ビジネスメトリクス

| メトリクス | 測定方法 | 確認頻度 |
|-----------|---------|---------|
| **予約成功率** | (成功件数 / 全予約件数) × 100 | 日次 |
| **決済成功率** | (決済完了件数 / 決済試行件数) × 100 | 日次 |
| **平均電話発信回数** | 予約成功までの平均店舗数 | 週次 |
| **キャンセル率** | (キャンセル件数 / 確定予約件数) × 100 | 週次 |

---

### 6.3 デプロイ管理

#### 6.3.1 デプロイ手順

| 項目 | 詳細 |
|------|------|
| **デプロイ方式** | Blue-Green Deployment |
| **実施時間帯** | 平日10:00〜18:00（営業時間内） |
| **ロールバック準備** | 前バージョンを24時間保持 |
| **デプロイ後確認** | ヘルスチェック、smoke test（5分） |

---

#### 6.3.2 CI/CD

| 項目 | ツール | 詳細 |
|------|-------|------|
| **CI** | GitHub Actions | プッシュ時に自動テスト実行 |
| **CD** | GitHub Actions + AWS CodeDeploy | mainブランチマージ時に自動デプロイ |
| **テスト** | pytest | ユニットテスト、統合テスト |
| **コードカバレッジ** | pytest-cov | 80%以上を維持 |

---

## 7. 保守性要件

### 7.1 コード品質

#### 7.1.1 コーディング規約

| 項目 | 詳細 |
|------|------|
| **言語** | Python 3.11以上 |
| **スタイルガイド** | PEP 8 |
| **Linter** | ruff |
| **Formatter** | black |
| **型ヒント** | 必須（mypy strict mode） |

---

#### 7.1.2 ドキュメント

| 項目 | 要件 |
|------|------|
| **関数docstring** | 全public関数に必須（Google形式） |
| **クラスdocstring** | 全クラスに必須 |
| **README** | プロジェクトルートに配置、セットアップ手順記載 |
| **API仕様** | OpenAPI（Swagger）で自動生成 |

---

### 7.2 テスト要件

#### 7.2.1 テストカバレッジ

| テストタイプ | カバレッジ目標 | 実施タイミング |
|-------------|---------------|---------------|
| **ユニットテスト** | 80%以上 | コミット時（CI） |
| **統合テスト** | 主要フロー100% | PR作成時（CI） |
| **E2Eテスト** | 主要シナリオ5件 | デプロイ前 |

---

#### 7.2.2 テストデータ

| 項目 | 要件 |
|------|------|
| **本番データ使用** | 禁止 |
| **テスト用提携店** | 専用のテスト店舗CSVを用意 |
| **外部API** | モック使用（Bland.ai、Twilio、Stripe） |

---

### 7.3 変更管理

#### 7.3.1 バージョン管理

| 項目 | 詳細 |
|------|------|
| **バージョニング** | セマンティックバージョニング（x.y.z） |
| **リリースノート** | CHANGELOG.mdに記載 |
| **タグ付け** | リリース時にGitタグ作成 |

---

#### 7.3.2 変更レビュー

| 項目 | 要件 |
|------|------|
| **コードレビュー** | 全PR必須（最低1名の承認） |
| **レビュー観点** | 機能要件、コード品質、セキュリティ、テスト |

---

## 8. 互換性要件

### 8.1 MCPプロトコル互換性

| 項目 | 要件 |
|------|------|
| **MCPバージョン** | 1.0以上 |
| **対応クライアント** | Claude Desktop、ChatGPT、その他MCPクライアント |
| **後方互換性** | MCPプロトコル更新時も既存クライアントをサポート |

---

### 8.2 外部API互換性

| サービス | APIバージョン | 互換性方針 |
|---------|--------------|----------|
| **Bland.ai** | v1 | 破壊的変更時は移行期間を設ける |
| **Twilio** | 2010-04-01 | 安定版APIを使用 |
| **Stripe** | 2023-10-16 | バージョン固定、計画的にアップグレード |
| **SendGrid** | v3 | 安定版APIを使用 |

---

### 8.3 ブラウザ互換性（管理画面）

将来実装する管理画面について：

| ブラウザ | サポートバージョン |
|---------|------------------|
| **Google Chrome** | 最新版 + 1つ前のバージョン |
| **Firefox** | 最新版 + 1つ前のバージョン |
| **Safari** | 最新版 + 1つ前のバージョン |
| **Edge** | 最新版 + 1つ前のバージョン |

---

**文書終了**
