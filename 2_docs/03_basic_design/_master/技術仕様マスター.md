# 技術仕様マスター

**文書バージョン:** 1.1
**作成日:** 2025-01-27
**最終更新日:** 2025-01-28
**目的:** QRVシステムで採用する技術スタックの詳細仕様
**関連文書:** 01_技術選定/

---

## 目次

1. [概要](#1-概要)
2. [言語・ランタイム](#2-言語ランタイム)
3. [Webフレームワーク](#3-webフレームワーク)
4. [非同期処理](#4-非同期処理)
5. [データベース](#5-データベース)
6. [外部サービス](#6-外部サービス)
7. [開発ツール](#7-開発ツール)
8. [インフラ・デプロイ](#8-インフラデプロイ)

---

## 1. 概要

### 1.1 技術選定の基準

QRVシステムの技術選定は、以下の基準に基づいて行われています：

1. **初心者フレンドリー**: 学習コストが低く、わかりやすい
2. **シンプルさ**: 複雑な設定を避け、最小構成で動作する
3. **実績**: 広く使われており、情報が豊富
4. **拡張性**: 将来的なスケールに対応可能
5. **コスト**: 開発・運用コストを抑える

---

## 2. 言語・ランタイム

### 2.1 Python

**バージョン:** 3.11 以降（推奨: 3.12）

**選定理由:**
- 初心者にも読みやすい文法
- 豊富なライブラリとエコシステム
- AI/ML分野で標準的に使用されている
- FastAPI、Celery等の優れたフレームワークが利用可能

**インストール:**
```bash
# Windows
https://www.python.org/downloads/

# macOS
brew install python@3.12

# Linux (Ubuntu)
sudo apt install python3.12
```

**バージョン確認:**
```bash
python --version
# Python 3.12.x
```

---

### 2.2 Node.js

**バージョン:** 18 LTS以降（推奨: 20 LTS）

**用途:** MCP Server（npx経由での実行）

**選定理由:**
- MCP公式SDKがNode.js/TypeScriptで提供されている
- npxで簡単にパッケージを実行できる

**インストール:**
```bash
# Windows/macOS
https://nodejs.org/

# Linux (Ubuntu)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**バージョン確認:**
```bash
node --version
# v20.x.x

npx --version
# 10.x.x
```

---

## 3. Webフレームワーク

### 3.1 FastAPI

**バージョン:** 0.109.0 以降

**公式サイト:** https://fastapi.tiangolo.com/

**選定理由:**
- 高速（Starlette + Pydantic）
- 自動APIドキュメント生成（Swagger UI）
- 型ヒントによる自動バリデーション
- 非同期処理のネイティブサポート
- 学習コストが低い

**インストール:**
```bash
pip install fastapi[all]
```

**基本的な使い方:**
```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
async def root():
    return {"message": "Hello World"}
```

**開発サーバー起動:**
```bash
uvicorn main:app --reload
```

**APIドキュメント:**
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

---

### 3.2 Uvicorn

**バージョン:** 0.27.0 以降

**用途:** FastAPIのASGIサーバー

**選定理由:**
- FastAPIの推奨サーバー
- 高速で軽量
- ホットリロード対応

**インストール:**
```bash
pip install uvicorn[standard]
```

---

## 4. 非同期処理

### 4.1 Celery

**バージョン:** 5.3.0 以降

**公式サイト:** https://docs.celeryq.dev/

**選定理由:**
- Pythonの分散タスクキュー標準
- 並列処理、スケジューリングに対応
- リトライ、タイムアウト機能が充実
- 多数の実績と豊富なドキュメント

**用途:**
- 電話代行タスク（Bland.ai呼び出し）
- SMS送信タスク（Twilio呼び出し）
- リマインダー送信タスク（スケジュール実行）
- タイムアウト監視タスク

**インストール:**
```bash
pip install celery[redis]
```

**基本設定:**
```python
from celery import Celery

app = Celery('qrv', broker='redis://localhost:6379/0')

@app.task
def send_sms(phone_number, message):
    # SMS送信処理
    pass
```

---

### 4.2 Redis

**バージョン:** 7.0 以降

**用途:** Celeryのメッセージブローカー・結果バックエンド

**選定理由:**
- 高速なインメモリDB
- Celeryの推奨ブローカー
- シンプルな設定

**インストール:**
```bash
# Windows
https://github.com/microsoftarchive/redis/releases

# macOS
brew install redis

# Linux (Ubuntu)
sudo apt install redis-server
```

**起動:**
```bash
redis-server
```

**動作確認:**
```bash
redis-cli ping
# PONG
```

---

### 4.3 Celery Beat

**バージョン:** Celeryに含まれる

**用途:** スケジュールタスクの実行

**使用例:**
- 毎時0分にリマインダー送信対象をチェック
- 毎分タイムアウト監視

**設定例:**
```python
from celery.schedules import crontab

app.conf.beat_schedule = {
    'send-reminders-every-hour': {
        'task': 'tasks.send_reminders',
        'schedule': crontab(minute=0),
    },
}
```

---

## 5. データベース

### 5.1 PostgreSQL

**バージョン:** 15.0 以降（推奨: 16.x）

**用途:** 全環境（開発・テスト・本番）

**選定理由:**
- 堅牢なRDBMS
- 同時接続対応
- トランザクションの信頼性
- Railway、Renderで標準サポート
- 全環境で同一のDBを使用することで、環境差異を最小化

**開発環境:**
- Docker Composeによるローカル起動
- コンテナベースで環境を統一

**接続文字列:**
```python
DATABASE_URL = "postgresql://user:password@localhost:5432/qrv"
```

**インストール:**
```bash
# Windows
https://www.postgresql.org/download/windows/

# macOS
brew install postgresql@16

# Linux (Ubuntu)
sudo apt install postgresql-16
```

---

### 5.2 SQLAlchemy

**バージョン:** 2.0.0 以降

**用途:** ORM（Object-Relational Mapping）

**選定理由:**
- Pythonの標準的なORM
- PostgreSQL対応
- FastAPIと相性が良い
- 型ヒント対応

**インストール:**
```bash
pip install sqlalchemy
```

**基本的な使い方:**
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

engine = create_engine("postgresql://user:password@localhost:5432/qrv")
SessionLocal = sessionmaker(bind=engine)
```

---

### 5.3 Alembic

**バージョン:** 1.13.0 以降

**用途:** データベースマイグレーション

**選定理由:**
- SQLAlchemyの公式マイグレーションツール
- バージョン管理が可能

**インストール:**
```bash
pip install alembic
```

---

## 6. 外部サービス

### 6.1 Bland.ai

**用途:** 音声AI電話

**公式サイト:** https://docs.bland.ai

**API仕様:**
- REST API（requests ライブラリで直接呼び出し）
- 認証: APIキー
- レート制限: 要確認

**連携方法:**
- Python標準のrequestsライブラリを使用
- 公式SDKは使用しない（Preview版のため安定性を考慮）

**料金:**
- 従量課金: $0.09/分〜
- 無料トライアル: $5分

---

### 6.2 Twilio

**用途:** SMS送信

**公式サイト:** https://www.twilio.com/docs

**API仕様:**
- REST API
- 認証: Account SID + Auth Token

**Pythonライブラリ:**
```bash
pip install twilio
```

**料金:**
- SMS送信: 約¥10/通

---

### 6.3 Stripe

**用途:** オンライン決済

**公式サイト:** https://stripe.com/docs

**API仕様:**
- REST API
- 認証: APIキー（Secret Key）
- Webhook: イベント通知

**Pythonライブラリ:**
```bash
pip install stripe
```

**料金:**
- 決済手数料: 3.6%

---

### 6.4 SendGrid

**用途:** Email送信

**公式サイト:** https://docs.sendgrid.com/

**API仕様:**
- REST API
- 認証: APIキー

**Pythonライブラリ:**
```bash
pip install sendgrid
```

**料金:**
- 無料枠: 100通/日
- 有料: $19.95/月〜

---

### 6.5 MCP (Model Context Protocol)

**用途:** AIエージェントとの連携

**公式サイト:** https://modelcontextprotocol.io

**SDK:**
```bash
# Node.js/TypeScript（MCPサーバー実装用）
npm install @modelcontextprotocol/sdk

# Python（MCPサーバー実装用）
pip install mcp
```

**対応クライアント:**
- Claude Desktop
- ChatGPT（MCP対応版）

---

### 6.6 暗号化ライブラリ

**ライブラリ:** cryptography

**バージョン:** 42.0.0 以降

**用途:** データベース暗号化（Data at Rest）

**公式サイト:** https://cryptography.io/

**選定理由:**
- Python暗号化ライブラリの標準
- Fernet（対称暗号化）サポート
- AES 128bit CBC + HMAC による安全性
- シンプルなAPI
- 改ざん検知機能を標準装備

**暗号化方式:**
- Fernet（対称暗号化）
- AES 128-bit CBC mode
- HMAC for authentication

**インストール:**
```bash
pip install cryptography
```

**暗号化対象:**
- 予約処理に関わる全データ（11フィールド）
- 詳細は [データ項目マスター.md](データ項目マスター.md) および [用語定義マスター.md](用語定義マスター.md) を参照

---

## 7. 開発ツール

### 7.1 パッケージ管理

**ツール:** uv

**バージョン:** 0.1.0 以降

**公式サイト:** https://github.com/astral-sh/uv

**選定理由:**
- 超高速（pipの10〜100倍）
- Rust製で信頼性が高い
- requirements.txt完全互換
- pip と同じコマンド体系
- pyproject.tomlサポート

**インストール:**
```bash
# Windows/macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh
```

**使用方法:**
- pip と同じコマンドが使用可能
- requirements.txt を引き続き使用

**requirements.txt例:**
```
fastapi[all]==0.109.0
celery[redis]==5.3.0
sqlalchemy==2.0.25
alembic==1.13.1
twilio==8.11.0
stripe==8.0.0
sendgrid==6.11.0
cryptography==42.0.0
python-dotenv==1.0.0
pytest==7.4.4
pytest-asyncio==0.23.3
```

---

### 7.2 コードフォーマット

**ツール:** Black

**バージョン:** 24.0.0 以降

**選定理由:**
- 「妥協しない」コードフォーマッター
- 設定不要で統一されたスタイル

**インストール:**
```bash
pip install black
```

**使用方法:**
```bash
black .
```

---

### 7.3 リンター

**ツール:** Ruff

**バージョン:** 0.1.0 以降

**選定理由:**
- 高速（Rust製）
- Flake8、isort、pydocstyleなどを統合
- 設定が簡単

**インストール:**
```bash
pip install ruff
```

**使用方法:**
```bash
ruff check .
```

---

### 7.4 型チェック

**ツール:** mypy（オプション）

**バージョン:** 1.8.0 以降

**インストール:**
```bash
pip install mypy
```

**使用方法:**
```bash
mypy .
```

---

### 7.5 テストフレームワーク

**ツール:** pytest

**バージョン:** 7.4.0 以降

**選定理由:**
- Pythonの標準的なテストフレームワーク
- シンプルで強力
- 豊富なプラグイン

**インストール:**
```bash
pip install pytest pytest-asyncio
```

**使用方法:**
```bash
pytest
```

---

## 8. インフラ・デプロイ

### 8.1 Docker Compose

**バージョン:** 2.0 以降

**用途:** ローカル開発環境

**公式サイト:** https://docs.docker.com/compose/

**選定理由:**
- PostgreSQL、Redisを簡単に起動できる
- 環境の一貫性を保つ
- チーム開発での環境差異を削減
- 設定ファイルでインフラを管理

**構成要素:**
- PostgreSQL: データベース
- Redis: Celeryのブローカー
- FastAPI: Webアプリケーション
- Celery Worker: 非同期タスク処理
- Celery Beat: スケジュールタスク

**設定ファイル:**
- docker-compose.yml にサービス定義を記述
- 詳細は詳細設計フェーズで定義

---

### 8.2 ホスティング

**候補:** Railway または Render

**選定基準:**
- 無料枠または低コスト
- PostgreSQL対応
- 簡単なデプロイ
- 環境変数管理

#### Railway
- 公式サイト: https://railway.app/
- 無料枠: $5/月
- PostgreSQLプラグイン対応

#### Render
- 公式サイト: https://render.com/
- 無料枠: あり（制限付き）
- PostgreSQL対応

---

### 8.3 環境変数管理

**ツール:** python-dotenv

**バージョン:** 1.0.0 以降

**選定理由:**
- シンプルで初心者フレンドリー
- `.env`ファイルから環境変数を読み込む

**インストール:**
```bash
pip install python-dotenv
```

**環境変数カテゴリ:**
- Bland.ai: API認証キー
- Twilio: SMS送信認証情報
- Stripe: 決済API認証情報
- SendGrid: メール送信認証情報
- Database: PostgreSQL接続文字列
- Redis: Celeryブローカー接続文字列
- Encryption: データ暗号化キー

---

### 8.4 バージョン管理

**ツール:** Git

**リポジトリ:** GitHub（推奨）

**ブランチ戦略:**
- `main`: 本番環境
- `develop`: 開発環境
- `feature/*`: 機能開発

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-01-27 | 初版作成 |
| 1.1 | 2025-01-28 | 技術スタック変更（SQLite削除、PostgreSQL全環境採用、uv導入、Bland.ai REST API採用、Docker Compose追加、暗号化ライブラリ追加） |

---

**文書終了**
