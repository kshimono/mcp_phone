# エンドポイントマスター

**文書バージョン:** 1.0
**作成日:** 2025-01-27
**目的:** QRVシステムの全APIエンドポイント一覧
**関連文書:** 03_API設計/

---

## 目次

1. [概要](#1-概要)
2. [MCP Server API](#2-mcp-server-api)
3. [FastAPI - 予約管理](#3-fastapi---予約管理)
4. [FastAPI - 決済管理](#4-fastapi---決済管理)
5. [FastAPI - 通知管理](#5-fastapi---通知管理)
6. [FastAPI - 管理機能](#6-fastapi---管理機能)
7. [外部API呼び出し](#7-外部api呼び出し)

---

## 1. 概要

### 1.1 APIの分類

QRVシステムは以下のAPIで構成されます：

1. **MCP Server API**: Claude Desktop等のMCPクライアントからの呼び出し
2. **FastAPI**: 内部API、画面からの呼び出し、外部Webhook
3. **外部API**: Bland.ai、Twilio、Stripe、SendGridへの呼び出し

### 1.2 認証方式

| API種別 | 認証方式 |
|---------|---------|
| MCP Server | MCPトークン（環境変数） |
| FastAPI（内部） | なし（ローカルのみ） |
| FastAPI（Webhook） | Stripe Signature検証 |
| FastAPI（画面） | UUID URLパラメータ |

### 1.3 ベースURL

| 環境 | ベースURL |
|------|----------|
| 開発 | `http://localhost:8000` |
| テスト | `https://qrv-test.qualfia.com` |
| 本番 | `https://qrv.qualfia.com` |

---

## 2. MCP Server API

### 2.1 create_reservation

**説明:** 予約を作成する

**ツール名:** `create_reservation`

**パラメータ:**
```json
{
  "service_type": "00001",
  "customer_phone": "08012345678",
  "service_details": {
    "delivery_address": "東京都渋谷区道玄坂1-2-3",
    "preferred_date": "2025-01-28",
    "time_range": "14:00-17:00",
    "preferred_duration": 60,
    "fallback_duration": 40
  }
}
```

**レスポンス:**
```json
{
  "success": true,
  "reservation_id": "QRV-A3F9D2",
  "message": "予約IDが発行されました。SMSで確認リンクをお送りします。"
}
```

**エラーレスポンス:**
```json
{
  "success": false,
  "error_code": "ERR-VAL-001",
  "message": "必須項目が不足しています"
}
```

---

### 2.2 check_reservation_status

**説明:** 予約状況を確認する

**ツール名:** `check_reservation_status`

**パラメータ:**
```json
{
  "reservation_id": "QRV-A3F9D2"
}
```

**レスポンス:**
```json
{
  "success": true,
  "reservation_id": "QRV-A3F9D2",
  "status": "payment_pending",
  "service_type": "00001",
  "created_at": "2025-01-27T15:00:00+09:00",
  "details": {
    "delivery_address": "東京都渋谷区道玄坂1-2-3",
    "preferred_date": "2025-01-28",
    "time_range": "14:00-17:00",
    "preferred_duration": 60
  },
  "next_action": "決済リンクから決済を完了してください"
}
```

---

## 3. FastAPI - 予約管理

### 3.1 POST /api/reservations

**説明:** 予約を作成（MCP Serverから内部呼び出し）

**URL:** `POST /api/reservations`

**リクエスト:**
```json
{
  "service_type": "00001",
  "customer_phone": "08012345678",
  "request_details": {
    "delivery_address": "東京都渋谷区道玄坂1-2-3",
    "preferred_date": "2025-01-28",
    "time_range": "14:00-17:00",
    "preferred_duration": 60
  }
}
```

**レスポンス:** 201 Created
```json
{
  "reservation_id": "QRV-A3F9D2",
  "status": "pending_confirmation",
  "created_at": "2025-01-27T15:00:00+09:00"
}
```

---

### 3.2 GET /api/reservations/{reservation_id}

**説明:** 予約情報を取得

**URL:** `GET /api/reservations/{reservation_id}`

**パラメータ:**
- `reservation_id`: 予約ID

**レスポンス:** 200 OK
```json
{
  "reservation_id": "QRV-A3F9D2",
  "service_type": "00001",
  "customer_phone": "08012345678",
  "status": "payment_pending",
  "price": 2200,
  "created_at": "2025-01-27T15:00:00+09:00",
  "updated_at": "2025-01-27T15:05:00+09:00"
}
```

---

### 3.3 PATCH /api/reservations/{reservation_id}/status

**説明:** 予約ステータスを更新（内部API）

**URL:** `PATCH /api/reservations/{reservation_id}/status`

**リクエスト:**
```json
{
  "status": "confirmed",
  "notes": "SMS確認完了"
}
```

**レスポンス:** 200 OK
```json
{
  "reservation_id": "QRV-A3F9D2",
  "status": "confirmed",
  "updated_at": "2025-01-27T15:05:00+09:00"
}
```

---

### 3.4 GET /confirm/{confirmation_id}

**説明:** SMS確認画面を表示

**URL:** `GET /confirm/{confirmation_id}`

**パラメータ:**
- `confirmation_id`: 確認ID（UUID）

**レスポンス:** 200 OK（HTML）

**処理:**
1. confirmation_linksテーブルを検索
2. 有効期限チェック
3. 予約内容を表示
4. 「進める」「キャンセル」ボタン表示

---

### 3.5 POST /confirm/{confirmation_id}/proceed

**説明:** SMS確認「進める」ボタン押下

**URL:** `POST /confirm/{confirmation_id}/proceed`

**リクエスト:** なし（ボタン押下のみ）

**レスポンス:** 200 OK
```json
{
  "message": "予約処理を開始しました",
  "reservation_id": "QRV-A3F9D2"
}
```

**処理:**
1. 確認済みフラグを更新
2. 予約ステータスを`confirmed`に更新
3. 電話代行タスクをキューに追加

---

### 3.6 POST /confirm/{confirmation_id}/cancel

**説明:** SMS確認「キャンセル」ボタン押下

**URL:** `POST /confirm/{confirmation_id}/cancel`

**リクエスト:** なし（ボタン押下のみ）

**レスポンス:** 200 OK
```json
{
  "message": "予約をキャンセルしました"
}
```

**処理:**
1. 予約を削除またはステータスを`cancelled`に更新
2. 通知なし

---

## 4. FastAPI - 決済管理

### 4.1 GET /book/{payment_id}

**説明:** 決済画面を表示（Stripe Checkoutにリダイレクト）

**URL:** `GET /book/{payment_id}`

**パラメータ:**
- `payment_id`: 決済ID（UUID）

**レスポンス:** 302 Redirect to Stripe Checkout

**処理:**
1. payment_linksテーブルを検索
2. 有効期限チェック
3. Stripe Checkout Sessionを作成
4. Stripe CheckoutURLにリダイレクト

---

### 4.2 POST /api/payments/webhook

**説明:** Stripe Webhook受信

**URL:** `POST /api/payments/webhook`

**認証:** Stripe Signature検証

**イベント例:**
```json
{
  "id": "evt_...",
  "type": "checkout.session.completed",
  "data": {
    "object": {
      "id": "cs_test_...",
      "payment_status": "paid",
      "metadata": {
        "reservation_id": "QRV-A3F9D2"
      }
    }
  }
}
```

**レスポンス:** 200 OK

**処理:**
1. Signature検証
2. イベントタイプに応じた処理
   - `checkout.session.completed`: 決済完了処理
   - `checkout.session.expired`: 決済期限切れ処理

---

### 4.3 GET /payment/success

**説明:** 決済完了画面

**URL:** `GET /payment/success?session_id={stripe_session_id}`

**パラメータ:**
- `session_id`: Stripe Session ID

**レスポンス:** 200 OK（HTML）

**表示内容:**
- 決済完了メッセージ
- 予約ID
- 予約内容
- 次のステップ案内

---

### 4.4 GET /payment/cancel

**説明:** 決済キャンセル画面

**URL:** `GET /payment/cancel`

**レスポンス:** 200 OK（HTML）

**表示内容:**
- 決済がキャンセルされた旨
- 再試行のリンク

---

## 5. FastAPI - 通知管理

### 5.1 POST /api/notifications/sms

**説明:** SMS送信（内部API）

**URL:** `POST /api/notifications/sms`

**リクエスト:**
```json
{
  "reservation_id": "QRV-A3F9D2",
  "recipient": "08012345678",
  "template_name": "confirmation_request",
  "variables": {
    "reservation_id": "QRV-A3F9D2",
    "confirmation_url": "https://qualfia.com/phone/confirm/550e8400..."
  }
}
```

**レスポンス:** 201 Created
```json
{
  "notification_id": "NOTIF-20250127150000-SMS",
  "status": "sent",
  "sent_at": "2025-01-27T15:00:00+09:00"
}
```

---

### 5.2 POST /api/notifications/email

**説明:** Email送信（内部API）

**URL:** `POST /api/notifications/email`

**リクエスト:**
```json
{
  "reservation_id": "QRV-A3F9D2",
  "recipient": "info@relax.jp",
  "template_name": "shop_temp_booking",
  "variables": {
    "reservation_id": "QRV-A3F9D2",
    "service_details": "..."
  }
}
```

**レスポンス:** 201 Created
```json
{
  "notification_id": "NOTIF-20250127150000-EMAIL",
  "status": "sent",
  "sent_at": "2025-01-27T15:00:00+09:00"
}
```

---

## 6. FastAPI - 管理機能

### 6.1 GET /cancel/{cancellation_id}

**説明:** キャンセル確認画面

**URL:** `GET /cancel/{cancellation_id}`

**パラメータ:**
- `cancellation_id`: キャンセルID（UUID）

**レスポンス:** 200 OK（HTML）

**処理:**
1. cancellation_linksテーブルを検索
2. 有効期限チェック（48時間前まで）
3. 予約内容を表示
4. 「キャンセルする」ボタン表示

---

### 6.2 POST /cancel/{cancellation_id}/confirm

**説明:** キャンセル実行

**URL:** `POST /cancel/{cancellation_id}/confirm`

**リクエスト:** なし（ボタン押下のみ）

**レスポンス:** 200 OK（HTML）

**処理:**
1. 予約ステータスを`cancelled`に更新
2. Stripeで返金処理
3. 依頼者・提携店にSMS/Email送信
4. キャンセル完了画面を表示

---

### 6.3 GET /admin/reservations

**説明:** 予約一覧（管理画面、将来実装）

**URL:** `GET /admin/reservations`

**認証:** 要管理者認証

**クエリパラメータ:**
- `status`: ステータスフィルタ
- `from_date`: 作成日fromdate
- `to_date`: 作成日to

**レスポンス:** 200 OK
```json
{
  "reservations": [
    {
      "reservation_id": "QRV-A3F9D2",
      "status": "paid",
      "customer_phone": "080****5678",
      "created_at": "2025-01-27T15:00:00+09:00"
    }
  ],
  "total": 1
}
```

---

## 7. 外部API呼び出し

### 7.1 Bland.ai - 電話発信

**エンドポイント:** `POST https://api.bland.ai/v1/calls`

**リクエスト:**
```json
{
  "phone_number": "+810312345678",
  "task": "予約内容を伝えて、対応可能か確認する",
  "voice": "japanese-female",
  "max_duration": 300
}
```

**レスポンス:**
```json
{
  "call_id": "call_...",
  "status": "queued"
}
```

**詳細:** 04_外部サービス連携/04-1_Bland.ai連携仕様.md 参照

---

### 7.2 Twilio - SMS送信

**エンドポイント:** `POST https://api.twilio.com/2010-04-01/Accounts/{AccountSid}/Messages.json`

**リクエスト:**
```
From=+1234567890
To=+818012345678
Body=【Qualfia予約代行】...
```

**レスポンス:**
```json
{
  "sid": "SM...",
  "status": "queued",
  "to": "+818012345678"
}
```

**詳細:** 04_外部サービス連携/04-2_Twilio連携仕様.md 参照

---

### 7.3 Stripe - Checkout Session作成

**エンドポイント:** `POST https://api.stripe.com/v1/checkout/sessions`

**リクエスト:**
```json
{
  "payment_method_types": ["card"],
  "line_items": [{
    "price_data": {
      "currency": "jpy",
      "product_data": {"name": "アロママッサージ 60分"},
      "unit_amount": 2200
    },
    "quantity": 1
  }],
  "mode": "payment",
  "success_url": "https://qualfia.com/phone/payment/success?session_id={CHECKOUT_SESSION_ID}",
  "cancel_url": "https://qualfia.com/phone/payment/cancel",
  "metadata": {
    "reservation_id": "QRV-A3F9D2"
  }
}
```

**レスポンス:**
```json
{
  "id": "cs_test_...",
  "url": "https://checkout.stripe.com/c/pay/cs_test_..."
}
```

**詳細:** 04_外部サービス連携/04-3_Stripe連携仕様.md 参照

---

### 7.4 SendGrid - Email送信

**エンドポイント:** `POST https://api.sendgrid.com/v3/mail/send`

**リクエスト:**
```json
{
  "personalizations": [{
    "to": [{"email": "info@relax.jp"}],
    "subject": "【Qualfia予約代行】予約確定通知"
  }],
  "from": {"email": "noreply@qualfia.com"},
  "content": [{
    "type": "text/html",
    "value": "<html>...</html>"
  }]
}
```

**レスポンス:** 202 Accepted

**詳細:** 04_外部サービス連携/04-4_SendGrid連携仕様.md 参照

---

## 8. エンドポイント一覧表

| # | メソッド | エンドポイント | 説明 | 認証 |
|---|---------|--------------|------|------|
| 1 | MCP | create_reservation | 予約作成 | MCPトークン |
| 2 | MCP | check_reservation_status | 予約状況確認 | MCPトークン |
| 3 | POST | /api/reservations | 予約作成（内部） | なし |
| 4 | GET | /api/reservations/{id} | 予約取得 | なし |
| 5 | PATCH | /api/reservations/{id}/status | ステータス更新 | なし |
| 6 | GET | /confirm/{id} | SMS確認画面 | UUID |
| 7 | POST | /confirm/{id}/proceed | 確認「進める」 | UUID |
| 8 | POST | /confirm/{id}/cancel | 確認「キャンセル」 | UUID |
| 9 | GET | /book/{id} | 決済画面 | UUID |
| 10 | POST | /api/payments/webhook | Stripe Webhook | Signature |
| 11 | GET | /payment/success | 決済完了画面 | なし |
| 12 | GET | /payment/cancel | 決済キャンセル画面 | なし |
| 13 | POST | /api/notifications/sms | SMS送信（内部） | なし |
| 14 | POST | /api/notifications/email | Email送信（内部） | なし |
| 15 | GET | /cancel/{id} | キャンセル確認画面 | UUID |
| 16 | POST | /cancel/{id}/confirm | キャンセル実行 | UUID |

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-01-27 | 初版作成 |

---

**文書終了**
